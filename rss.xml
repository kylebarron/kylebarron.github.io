<?xml version="1.0" encoding="UTF-8"?><rss xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:atom="http://www.w3.org/2005/Atom" version="2.0"><channel><title><![CDATA[Kyle Barron's blog]]></title><description><![CDATA[Kyle Barron]]></description><link>https://kylebarron.dev</link><generator>GatsbyJS</generator><lastBuildDate>Sat, 27 Aug 2022 11:30:14 GMT</lastBuildDate><item><title><![CDATA[Zero-copy Apache Arrow with WebAssembly]]></title><link>https://kylebarron.dev/blog/zero-copy-apache-arrow-with-webassembly</link><guid isPermaLink="false">https://kylebarron.dev/blog/zero-copy-apache-arrow-with-webassembly</guid><pubDate>Sun, 21 Aug 2022 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;Posted on Observable (&lt;a href=&quot;https://observablehq.com/@kylebarron/zero-copy-apache-arrow-with-webassembly&quot;&gt;https://observablehq.com/@kylebarron/zero-copy-apache-arrow-with-webassembly&lt;/a&gt;), and embedded below:&lt;/p&gt;&lt;iframe width=&quot;100%&quot; height=&quot;800&quot; frameBorder=&quot;0&quot; src=&quot;https://observablehq.com/embed/@kylebarron/zero-copy-apache-arrow-with-webassembly?cell=*&quot;&gt;&lt;/iframe&gt;</content:encoded></item><item><title><![CDATA[GeoArrow and GeoParquet in deck.gl]]></title><link>https://kylebarron.dev/blog/geoarrow-and-geoparquet-in-deck-gl</link><guid isPermaLink="false">https://kylebarron.dev/blog/geoarrow-and-geoparquet-in-deck-gl</guid><pubDate>Wed, 10 Aug 2022 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;Posted on Observable (&lt;a href=&quot;https://observablehq.com/@kylebarron/geoarrow-and-geoparquet-in-deck-gl&quot;&gt;https://observablehq.com/@kylebarron/geoarrow-and-geoparquet-in-deck-gl&lt;/a&gt;), and embedded below:&lt;/p&gt;&lt;iframe width=&quot;100%&quot; height=&quot;800&quot; frameBorder=&quot;0&quot; src=&quot;https://observablehq.com/embed/@kylebarron/geoarrow-and-geoparquet-in-deck-gl?cell=*&quot;&gt;&lt;/iframe&gt;</content:encoded></item><item><title><![CDATA[GeoParquet on the Web]]></title><link>https://kylebarron.dev/blog/geoparquet-on-the-web</link><guid isPermaLink="false">https://kylebarron.dev/blog/geoparquet-on-the-web</guid><pubDate>Tue, 19 Apr 2022 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;Posted on Observable (&lt;a href=&quot;https://observablehq.com/@kylebarron/geoparquet-on-the-web&quot;&gt;https://observablehq.com/@kylebarron/geoparquet-on-the-web&lt;/a&gt;), and embedded below:&lt;/p&gt;&lt;iframe width=&quot;100%&quot; height=&quot;800&quot; frameBorder=&quot;0&quot; src=&quot;https://observablehq.com/embed/@kylebarron/geoparquet-on-the-web?cell=*&quot;&gt;&lt;/iframe&gt;</content:encoded></item><item><title><![CDATA[Serverless High-Resolution Aerial Imagery for the U.S.]]></title><link>https://kylebarron.dev/blog/cog-mosaic/naip</link><guid isPermaLink="false">https://kylebarron.dev/blog/cog-mosaic/naip</guid><pubDate>Tue, 01 Sep 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;&lt;a href=&quot;http://kylebarron.github.io/naip-cogeo-mosaic/&quot;&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:54.58333333333334%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDAQT/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABWPRGL0QT/8QAGhAAAQUBAAAAAAAAAAAAAAAAAAECEBExMv/aAAgBAQABBQJcKHcx/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGhAAAwEAAwAAAAAAAAAAAAAAAAERITFhwf/aAAgBAQABPyFZocTsouhyj8LiP//aAAwDAQACAAMAAAAQiM//xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8Qta//xAAVEQEBAAAAAAAAAAAAAAAAAAABEP/aAAgBAgEBPxAn/8QAGhABAAMBAQEAAAAAAAAAAAAAAQARMSFhkf/aAAgBAQABPxBAVrz2EIye3YQKsXdbnxzBw05FW3pP/9k=&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;60cm-resolution NAIP imagery of the Grand Canyon from 2017&quot; title=&quot;60cm-resolution NAIP imagery of the Grand Canyon from 2017&quot; src=&quot;/static/da6e407cc9e40feacc0aafa2ddab473d/18e3b/grca.jpg&quot; srcSet=&quot;/static/da6e407cc9e40feacc0aafa2ddab473d/46946/grca.jpg 240w,/static/da6e407cc9e40feacc0aafa2ddab473d/55489/grca.jpg 480w,/static/da6e407cc9e40feacc0aafa2ddab473d/18e3b/grca.jpg 960w,/static/da6e407cc9e40feacc0aafa2ddab473d/60e21/grca.jpg 1440w,/static/da6e407cc9e40feacc0aafa2ddab473d/ae03e/grca.jpg 1767w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;60cm-resolution imagery of the Grand Canyon from 2017. &lt;strong&gt;&lt;a href=&quot;http://kylebarron.github.io/naip-cogeo-mosaic/&quot;&gt;Click for an
interactive example&lt;/a&gt;&lt;/strong&gt;.&lt;/p&gt;&lt;h2 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;p&gt;More and more public imagery sources are being provided in &lt;a href=&quot;https://www.cogeo.org/&quot;&gt;Cloud-Optimized
GeoTIFF (COG)&lt;/a&gt;, an efficient file format for fast random-access reads
of geospatial raster data. This is revolutionary because the format enables new
cloud-native workflows, such as serving imagery to a web map on demand, that
were never before possible.&lt;/p&gt;&lt;p&gt;Within half a second, a server can grab and combine the relevant portions of
half a dozen images, reproject into the coordinate reference system used in web
mapping, and return it to the user. Making this process happen on demand can
lead to huge reductions in cost—and zero fixed cost—as terabytes of map data no
longer need to be stored pregenerated and stored.&lt;/p&gt;&lt;p&gt;This post builds upon a &lt;a href=&quot;https://kylebarron.dev/blog/cog-mosaic/overview&quot;&gt;previous overview post&lt;/a&gt; to give more
concrete details on working with the &lt;a href=&quot;https://registry.opendata.aws/naip/&quot;&gt;public NAIP collection on AWS
S3&lt;/a&gt;, a repository of cloudless aerial imagery spanning the lower 48
U.S. states at up to 60-centimeter resolution. In the following sections I&amp;#x27;ll
give an overview of the imagery available and best practices for optimal
performance. For deployment instructions and other documentation, &lt;a href=&quot;https://github.com/kylebarron/naip-cogeo-mosaic&quot;&gt;visit the
project on Github&lt;/a&gt;.&lt;/p&gt;&lt;h2 id=&quot;naip-data&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#naip-data&quot; aria-label=&quot;naip data permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;NAIP Data&lt;/h2&gt;&lt;p&gt;The U.S. Department of Agriculture (USDA) oversees the &lt;a href=&quot;https://www.fsa.usda.gov/programs-and-services/aerial-photography/imagery-programs/naip-imagery/&quot;&gt;National Agriculture
Imagery Program (NAIP)&lt;/a&gt;. Since 2003, this program has collected
high-resolution aerial imagery of the continental U.S., with recent years
photographed at 60-centimeter resolution. This data has been free to use for a
while, but historically has been locked in cloud-unfriendly,
&lt;a href=&quot;https://en.wikipedia.org/wiki/MrSID&quot;&gt;closed-source&lt;/a&gt; formats.&lt;/p&gt;&lt;p&gt;However, thanks to the AWS Open Data program, NAIP imagery from 2011 to 2018 is
available on a &lt;a href=&quot;https://registry.opendata.aws/naip/&quot;&gt;public S3 bucket&lt;/a&gt; in &lt;a href=&quot;https://www.cogeo.org/&quot;&gt;Cloud-Optimized GeoTIFF
(COG)&lt;/a&gt; format. As I explained in a &lt;a href=&quot;https://kylebarron.dev/blog/cog-mosaic/overview&quot;&gt;previous blog post&lt;/a&gt;,
COGs democratize access to large collections of raster data by enabling fast
random-access reads.&lt;/p&gt;&lt;p&gt;Given this large collection of data freely available in a cloud-friendly format,
we can render map tiles from this imagery on demand with low latency, generally
within 500ms. This on-demand rendering provides multiple benefits:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Lower costs. By not storing a copy of the data, you can avoid storage costs for pregenerated imagery. Source NAIP data is over 30TB in size; just to store that data on S3 would cost several hundred dollars a month.&lt;/li&gt;&lt;li&gt;Greater image selection flexibility. By not pregenerating any imagery, you can give users the choice of what year&amp;#x27;s data to view. As soon as a new year&amp;#x27;s data exists, your maps can be updated.&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;mosaicjson&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#mosaicjson&quot; aria-label=&quot;mosaicjson permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MosaicJSON&lt;/h2&gt;&lt;p&gt;As described in my &lt;a href=&quot;https://kylebarron.dev/blog/cog-mosaic/overview#mosaicjson&quot;&gt;COG overview blog post&lt;/a&gt;:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;It&amp;#x27;s great that all those terabytes of COG exist for public consumption, but
you still need a way to select what portions of imagery to combine. That&amp;#x27;s
where &lt;a href=&quot;https://github.com/developmentseed/mosaicjson-spec&quot;&gt;MosaicJSON&lt;/a&gt; comes in. It&amp;#x27;s a file that determines what
source files should be merged to create each web mercator map tile.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;Dynamic tiling works by combining multiple source images into a single output
image in the web mercator projection ready to send back to the client. This
process requires quickly finding the source images that are necessary to combine
for the desired tile.&lt;/p&gt;&lt;p&gt;In the NAIP case, the process of assembling a MosaicJSON is relatively simple as
the source imagery is intentionally collected in such a way as to create a
seamless mosaic per state. Images are produced in a regular grid with little
overlap between source images, all imagery is cloudless, there exists minimal
temporal variation (at least within a state), and the dataset is relatively
static (updated yearly).&lt;/p&gt;&lt;p&gt;These factors make it considerably easier to work with mosaics for NAIP imagery
than for satellite imagery, which has more overlap between scenes, large
portions of missing or cloudy data, and high temporal variation.&lt;/p&gt;&lt;p&gt;The main thing to keep in mind when creating an NAIP mosaic is to avoid
including multiple years of imagery in a single mosaic, which can slow down
dynamic tiling. Most of &lt;code&gt;naip-cogeo-mosaic&lt;/code&gt; is dedicated to working with the
NAIP metadata to create a seamless, efficient mosaic. Consult &lt;a href=&quot;https://github.com/kylebarron/naip-cogeo-mosaic&quot;&gt;its
documentation&lt;/a&gt; for more information.&lt;/p&gt;&lt;h2 id=&quot;image-overviews&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#image-overviews&quot; aria-label=&quot;image overviews permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Image Overviews&lt;/h2&gt;&lt;p&gt;Cloud-Optimized GeoTIFF files include a number of internal &lt;em&gt;overviews&lt;/em&gt;:
lower-resolution, downsampled versions of the image, which are precomputed and
stored with the image. Each overview level halves the height and width pixels,
so each additional level reduces the resolution by a factor of 2. These
overviews enable fast reads at a range of resolutions by minimizing the
amount of bytes that need to be read.&lt;/p&gt;&lt;p&gt;NAIP imagery in the &lt;code&gt;naip-visualization&lt;/code&gt; S3 bucket have full-resolution data
plus 5 levels of overviews. This means that NAIP data can be read most
efficiently at &lt;em&gt;six&lt;/em&gt; zoom levels, in this case zooms 12-17. At zooms higher than
17, the images look pixelated. At zooms lower than 12, many images need to be
combined and downsampled on the fly. To create an image for a single zoom 6
mercator tile, you&amp;#x27;d need to read &lt;em&gt;4,096&lt;/em&gt; times more data at level 12, then
downsample.&lt;/p&gt;&lt;p&gt;Unsurprisingly, needing to fetch so many source images reduces performance when
rendering at lower zooms. A solution to this problem is to create &lt;em&gt;pregenerated
overviews&lt;/em&gt; for lower zooms: reading all necessary source images once then
downsampling ahead of time. Then when rendering lower zoom images, read from the
already-downsampled data.&lt;/p&gt;&lt;p&gt;In this case, to serve imagery for zooms 6-11 on the fly, I generate overview
images that are themselves Cloud-Optimized GeoTIFFs, each of which contains 5
internal overview levels. Pregenerating overviews does lose some flexibility of
COGs, as you need to choose how to combine imagery (your MosaicJSON) ahead of
time rather than on demand.&lt;/p&gt;&lt;p&gt;The &lt;a href=&quot;https://github.com/kylebarron/naip-cogeo-mosaic&quot;&gt;&lt;code&gt;naip-cogeo-mosaic&lt;/code&gt; documentation&lt;/a&gt; has more information
on how to use &lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic&quot;&gt;&lt;code&gt;cogeo-mosaic&lt;/code&gt;&lt;/a&gt; to create these overviews.&lt;/p&gt;&lt;h2 id=&quot;dynamic-tiling-performance&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#dynamic-tiling-performance&quot; aria-label=&quot;dynamic tiling performance permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Dynamic Tiling Performance&lt;/h2&gt;&lt;p&gt;I&amp;#x27;ve spent a lot of time working on performance for dynamic tiling, with the
goal of reducing latency to the point that it&amp;#x27;s viable for a wide range of
applications.&lt;/p&gt;&lt;p&gt;With my current serverless solution hosted on AWS Lambda, I&amp;#x27;m able to get around
500ms latency (longer for cold starts). In the following sections I&amp;#x27;ll outline
the things you should keep in mind to keep performance as high as possible.&lt;/p&gt;&lt;h3 id=&quot;minimize-number-of-source-assets&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#minimize-number-of-source-assets&quot; aria-label=&quot;minimize number of source assets permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Minimize number of source assets&lt;/h3&gt;&lt;p&gt;Since GDAL, the program underlying the dynamic tiling process, is synchronous,
the largest amount of time is spent waiting on network requests to S3 for each
portion of the image. Thus, one of the best ways to minimize total time is to
minimize the number of images the tiler has to fetch to combine into a single
web mercator tile.&lt;/p&gt;&lt;p&gt;As &lt;a href=&quot;#mosaicjson&quot;&gt;described above&lt;/a&gt;, this step is done ahead of time, while
creating the MosaicJSON. The process of minimizing superfluous source assets is
taken care of within &lt;code&gt;naip-cogeo-mosaic&lt;/code&gt; when you make a mosaic.&lt;/p&gt;&lt;h3 id=&quot;256x256-pixel-images&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#256x256-pixel-images&quot; aria-label=&quot;256x256 pixel images permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;256x256 pixel images&lt;/h3&gt;&lt;p&gt;Images used in web maps usually come in square images of either 256x256 pixels
or 512x512 pixels (@2x resolution). Using @2x resolution tiles requires fewer
requests to cover the screen, since each image covers a larger area at the same
resolution, but each request takes longer. With @1x scale tiles, each tile is
1/4th the size, so you&amp;#x27;ll need (roughly) four times the requests.&lt;/p&gt;&lt;p&gt;With this project, my goal is to push per-tile latency as low as possible.
Unsurprisingly, it takes significantly longer—my ballpark estimates are around 2
to 3 times longer—to generate a @2x scale image than a @1x scale image. Thus,
serving @1x scale images is preferable when you prioritize speed, but server
costs will be slightly higher since you need so many more requests.&lt;/p&gt;&lt;h3 id=&quot;locate-server-in-us-west-2&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#locate-server-in-us-west-2&quot; aria-label=&quot;locate server in us west 2 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Locate server in &lt;code&gt;us-west-2&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;The tiler works by&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Using the MosaicJSON to find URLs of source images that overlap the mercator tile of interest&lt;/li&gt;&lt;li&gt;Reading the relevant portion of each source image&lt;/li&gt;&lt;li&gt;Combining pixels into one output image ready to send back to the client&lt;/li&gt;&lt;/ol&gt;&lt;p&gt;While these three steps work with any file format, Cloud-Optimized GeoTIFFs
allow for huge speedups on the second part. The COG format is efficient because
it allows for intelligent streaming of portions of an image, but because a COG
is internally tiled, the tiling server will likely need several (small) GET
requests for each source image. Thus, locating the compute in the same region as
the data is absolutely essential for low total latency, as the latency for each
S3 GET request is larger across regions, and this time gets multiplied by the
number of requests per image, and the number of images needed to combine for one
mercator tile.&lt;/p&gt;&lt;p&gt;Additionally, since NAIP imagery is stored in a Requester Pays S3 bucket,
locating the server in the same region will be significantly cheaper as you
won&amp;#x27;t need to pay egress charges on intermediate data transfer.&lt;/p&gt;&lt;h3 id=&quot;use-gdal-24-not-31&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#use-gdal-24-not-31&quot; aria-label=&quot;use gdal 24 not 31 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Use GDAL 2.4, not 3.1&lt;/h3&gt;&lt;p&gt;As of summer 2020, GDAL 2.4 has been tested to be &lt;a href=&quot;https://github.com/lambgeo/docker-lambda/issues/2&quot;&gt;&lt;em&gt;significantly
faster&lt;/em&gt;&lt;/a&gt; (&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic-tiler/issues/4#issuecomment-604120617&quot;&gt;&amp;gt;10x&lt;/a&gt;) than GDAL 3.1, at least for this specific
use case.&lt;/p&gt;&lt;h3 id=&quot;use-dynamodb-as-the-mosaicjson-backend&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#use-dynamodb-as-the-mosaicjson-backend&quot; aria-label=&quot;use dynamodb as the mosaicjson backend permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Use DynamoDB as the MosaicJSON backend&lt;/h3&gt;&lt;p&gt;The MosaicJSON defines a mapping from mercator tiles to image urls. Since it
must define this mapping for &lt;em&gt;every mercator tile&lt;/em&gt; (at the minimum zoom, which
for NAIP is zoom 12), the MosaicJSON file can get quite large. When saved as a
JSON file, my United States-wide mosaics are 64MB. Since this mosaic is needed
for every dynamic tiling request, storing this data in a JSON file on S3
requires the lambda function download and parse it on every request. This adds
roughly 2.5s per request for such a large mosaic.&lt;/p&gt;&lt;p&gt;Luckily, there&amp;#x27;s an alternative to storing as JSON.
&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic&quot;&gt;&lt;code&gt;cogeo-mosaic&lt;/code&gt;&lt;/a&gt; supports multiple &lt;em&gt;backends&lt;/em&gt;, one of which is
&lt;a href=&quot;https://aws.amazon.com/dynamodb/&quot;&gt;DynamoDB&lt;/a&gt;, a serverless, low-latency key-value store. This is ideal
for storing mosaics because only one or sometimes two DynamoDB read requests are
necessary per dynamic tiling request. This lowers the time spent on the
MosaicJSON from 2.5s to around 20ms.&lt;/p&gt;&lt;h3 id=&quot;client-side-image-manipulation&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#client-side-image-manipulation&quot; aria-label=&quot;client side image manipulation permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Client-side image manipulation&lt;/h3&gt;&lt;p&gt;Often the NAIP imagery is visually a bit bland and benefits from increased
saturation. While it&amp;#x27;s possible to do this server side, it increases image load
times by 100-200ms. For WebGL-enabled map clients like Mapbox GL JS or
&lt;a href=&quot;https://deck.gl&quot;&gt;deck.gl&lt;/a&gt;, client-side image saturation is easy and
instantaneous, so this is better to do client side.&lt;/p&gt;&lt;h3 id=&quot;caching&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#caching&quot; aria-label=&quot;caching permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Caching&lt;/h3&gt;&lt;p&gt;I&amp;#x27;m a big fan of Cloudflare&amp;#x27;s free tier as a simple solution to both speed up my
site and keep costs low by reducing the number of requests that reach my server.
Some sort of caching is ideal.&lt;/p&gt;&lt;h2 id=&quot;pricing&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#pricing&quot; aria-label=&quot;pricing permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Pricing&lt;/h2&gt;&lt;p&gt;A rough estimate of the cost with my serverless approach is &lt;strong&gt;$25 per million
requests&lt;/strong&gt;. Note that this is only for requests &lt;em&gt;that reach Lambda&lt;/em&gt;; using
Cloudflare with a long Cache-Control setting should make it effectively even
cheaper.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Lambda compute time: $12.5/million requests. On average, each request takes around 500 ms, when Lambda is set to 1536 MB of memory. Note that this is for @1x tiles; @2x tiles take 2-3x longer for compute (but you need fewer requests). If you have significant, stable usage, you could save by not going serverless.&lt;/li&gt;&lt;li&gt;Lambda requests: $0.20/million.&lt;/li&gt;&lt;li&gt;DynamoDB requests: $0.25/million. Each dynamic tiling request needs a read request to DynamoDB to find the relevant image urls.&lt;/li&gt;&lt;li&gt;API Gateway requests: $1.00/million. I use the cheaper, newer HTTP API service instead of the older REST API service, which is $3.50/million.&lt;/li&gt;&lt;li&gt;S3 GET requests: $8.00/million. Since NAIP imagery is stored in a requester pays bucket, the user pays for the GET requests. On average there are 4 to 6 source images, and each COG requires between 1 and 5 GET requests, depending on the zoom level and technical factors.&lt;/li&gt;&lt;li&gt;Network egress: $2.00/million. Assuming image tiles are served as JPEGs, each image is roughly 25kb. Multiply by 4 if using @2x tiles. PNGs are significantly larger.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;This is a pretty good value. Once you surpass Mapbox&amp;#x27;s (generous) free tier,
their satellite imagery costs $250/million requests. (Though that&amp;#x27;s not a direct
apples-to-apples comparison, since you can request @2x tiles from Mapbox for
apparently the same price.) But apart from being cheap, a great benefit of the
dynamic tiling approach is that you can choose &lt;em&gt;any&lt;/em&gt; combination of imagery you
wish. It&amp;#x27;s just as easy to serve tiles from 2011 as it is from 2018.&lt;/p&gt;&lt;h2 id=&quot;drawbacks&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#drawbacks&quot; aria-label=&quot;drawbacks permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Drawbacks&lt;/h2&gt;&lt;p&gt;That said, there are a few drawbacks to using NAIP imagery and reasons why tiled
imagery from a commercial company such as Mapbox can often be better.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;strong&gt;No global coverage&lt;/strong&gt;: NAIP data only exists for the continental U.S. The highest-resolution public, global satellite imagery I know of is Sentinel 2 data, which has a 10-meter resolution.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Image quality&lt;/strong&gt;: while NAIP generally has good image quality, across large areas seams are quite noticeable. NAIP is ideal when zoomed in; it can look downsampled and patchy at low zooms.&lt;/li&gt;&lt;li&gt;&lt;strong&gt;Missing areas within U.S.&lt;/strong&gt;: some areas within the continental U.S., especially military bases, are not photographed by the NAIP program.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;Since this project was designed for exploration and to be &amp;quot;good enough&amp;quot; for
hobby mapping projects, these drawbacks are fine for my needs.&lt;/p&gt;&lt;h2 id=&quot;conclusion&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;&lt;p&gt;If you appreciate this data, &lt;strong&gt;talk to your elected officials&lt;/strong&gt;. &lt;a href=&quot;https://en.wikipedia.org/wiki/National_Agriculture_Imagery_Program&quot;&gt;According to
Wikipedia&lt;/a&gt;, USDA is considering removing NAIP imagery from the
public domain in the near future.&lt;/p&gt;&lt;h2 id=&quot;references&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#references&quot; aria-label=&quot;references permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/kylebarron/naip-cogeo-mosaic&quot;&gt;&lt;code&gt;naip-cogeo-mosaic&lt;/code&gt;&lt;/a&gt;: the open source project underlying this blog post. Refer to its documentation for how to deploy.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://developmentseed.org/titiler/&quot;&gt;Titiler&lt;/a&gt;: a next-generation dynamic tiling server that supports both serverless and server deployment. I&amp;#x27;d recommend this over &lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt; for all new deployments.&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;acknowledgements&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#acknowledgements&quot; aria-label=&quot;acknowledgements permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Acknowledgements&lt;/h2&gt;&lt;p&gt;Thanks to &lt;a href=&quot;https://twitter.com/_VincentS_&quot;&gt;Vincent Sarago&lt;/a&gt;, &lt;a href=&quot;https://twitter.com/geospatialjeff&quot;&gt;Jeff Albrecht&lt;/a&gt;, and many others for
their invaluable feedback and work pushing the Cloud-Optimized GeoTIFF ecosystem
forward.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Dynamic map tiling with Cloud-Optimized GeoTIFFs]]></title><link>https://kylebarron.dev/blog/cog-mosaic/overview</link><guid isPermaLink="false">https://kylebarron.dev/blog/cog-mosaic/overview</guid><pubDate>Mon, 11 May 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:58.333333333333336%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAADSElEQVQozy2SX2/bZBjFjeCCSaNdUjS4R1PXpe0GQhoTkzbarVW3bmvTrnOSJc1f23ESO3bsxE4cJ2mWJqVNu4VlMJSiwsaukZAYaDcILvkGyNIQH+Q5vAUe6dHzSq90dPQ7h/vLe02vfvmdHNWl6IZIu6qM570munoFB5aNh3YNB3YVXa0EW9TRyGpoKjZsrYNXP/6Kv/98jWxcI5lP40V/z+M6tR77bEEWq4gF4zisqfRt28awWsGzrouvWi72TBPtfAEdrYyWrMPJFNCydvB0/xCjJy+QTFqkqttIr8U9biOYpgQv4NpCjFwhQy8Hdfw0cOloy8Zhq4ahU0PfNPCoXMJB1UGbucuGRCQ3sthuPUGj3MWNxfsUCuvI3Et53IdXMjS/mEA0rJDEJ6itKBhYTMBU8aVTxm7JxOhBC98xt/u2g7pSh51WEV+XMNg7QjHfwNLcXbo6H8XHl+95nP+Cho+WHLq1pmEtKGJ1LUvRiIr1lSSauRyedWw873fwctTHwHH/5ddSLDiihnaxhtsrIuavRWh+IYFLV0IeNz1XxaerPfhmFApcLiASq2AzXECSFyHFZHR0E/uVMkbdNh7Vm+jpFkNgo6eWUIlLyEQE3OdFWl/NYOF6xOPGp3I4fV6lsbMSjU+mMDGt4OJVActLUYRWonA1C1bBwLBe/S9dgQmlVPQUA1XmUhcUmFmDyoKGOzc3Pe7kZJ5OTckYmxTwbkCgk2c1nJ5V6PpiHMEbYfww3MFO1cYXjOdD24UZV9GRNfQKOgzG0smzt27Q0LagJSSPGwuU4J/RyDej08R0Ab5AgXyBPJZvy1i/GcHnRgnfdBvsGnjs1tHWjitVw65SRKdQhByVWTdV6usazBQT9J/h6Z33L9IJf4D8kzGamC3ivQs5+mQui83VGDaWw/h+v4stndXI0fDb1008dhxs5ZhAOg85nEY5LlJDkGGnRI97g+OI+39PfRAk36wB/7RM41PH6cURvsXjgariqLeNp806/jis4edBDXoyh4qoQNvMoCtJpEZSyPGMIRsc75tvnSDfuSyNnVPBgqK3z+Rw/lIKoWUeQljAaLuPTGuAz9IOkpKLgV1Cv6RAT+WwJcpMMIO7dxLeP1tBEB9ZlJsHAAAAAElFTkSuQmCC&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Dynamic tiling of Landsat data. Credit @_VincentS_&quot; title=&quot;Dynamic tiling of Landsat data. Credit @_VincentS_&quot; src=&quot;/static/9dc9a6ea73735f4c5e7014b96fc18db5/7d769/awspds_readme_screenshot.png&quot; srcSet=&quot;/static/9dc9a6ea73735f4c5e7014b96fc18db5/5243c/awspds_readme_screenshot.png 240w,/static/9dc9a6ea73735f4c5e7014b96fc18db5/ab158/awspds_readme_screenshot.png 480w,/static/9dc9a6ea73735f4c5e7014b96fc18db5/7d769/awspds_readme_screenshot.png 960w,/static/9dc9a6ea73735f4c5e7014b96fc18db5/da8b6/awspds_readme_screenshot.png 1000w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;h2 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;p&gt;There&amp;#x27;s a new way to serve a raster basemap.&lt;/p&gt;&lt;p&gt;Historically, the barrier to entry of serving an image basemap was
quite high. You had have access to high quality satellite imagery, the compute
power to preprocess those images into the right format for the web, the storage
capability to store all that data, and the server capability to handle spikes in
traffic.&lt;/p&gt;&lt;p&gt;All that has changed.&lt;/p&gt;&lt;p&gt;With the advent of serverless computing, the Cloud-Optimized GeoTIFF (COG)
format, and large public repositories of such data, serving map tiles from large
collections of imagery is being democratized. It&amp;#x27;s now possible to serve tiles
on demand from a collection of terabytes of imagery, quickly, cheaply, and
easily.&lt;/p&gt;&lt;p&gt;In this post, I present an outline of this new ecosystem, and lay the groundwork
for future blog posts where I put this theory into practice, and show how to
implement these tools with existing, open data sets.&lt;/p&gt;&lt;h2 id=&quot;cloud-optimized-geotiffs&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#cloud-optimized-geotiffs&quot; aria-label=&quot;cloud optimized geotiffs permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cloud-Optimized GeoTIFFs&lt;/h2&gt;&lt;p&gt;As described on &lt;a href=&quot;https://www.cogeo.org/&quot;&gt;cogeo.org&lt;/a&gt;:&lt;/p&gt;&lt;blockquote&gt;&lt;p&gt;A Cloud Optimized GeoTIFF (COG) is a regular GeoTIFF file, aimed at being hosted on a HTTP file server, with an internal organization that enables more efficient workflows on the cloud. It does this by leveraging the ability of clients issuing ​HTTP GET range requests to ask for just the parts of a file they need.&lt;/p&gt;&lt;/blockquote&gt;&lt;p&gt;This new format is at the core of dynamic tiling. By making use of its internal
image &lt;em&gt;overviews&lt;/em&gt;, one can read &lt;em&gt;parts&lt;/em&gt; of the image over a network roughly in
proportion to the amount of data requested. The client needs only to read the
file&amp;#x27;s inital metadata to know the exact pattern and byte ranges of the rest of
the file. Then to read an image&amp;#x27;s top-right corner at mid-resolution, a minimal
number of additional requests can be made just for that data.&lt;/p&gt;&lt;p&gt;There are several large collections of publicly-available COG data, including:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://registry.opendata.aws/landsat-8/&quot;&gt;Landsat 8&lt;/a&gt;: Worldwide, medium resolution multi-spectral imagery since 2013, with new scenes added daily.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://registry.opendata.aws/naip/&quot;&gt;NAIP&lt;/a&gt;: High resolution (1-meter and 0.6-meter) true color &amp;quot;leaf-on&amp;quot; imagery for the continental 48 U.S. states, taken at regular intervals since 2011. Most states have been imaged four times since 2011.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://registry.opendata.aws/modis-astraea/&quot;&gt;MODIS&lt;/a&gt;: Worldwide, low resolution multi-spectral imagery captured by the MODIS satellite.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://registry.opendata.aws/cbers/&quot;&gt;CBERS&lt;/a&gt;: Medium resolution imagery captured by the China-Brazil Earth Resources Satellite. It doesn&amp;#x27;t have worldwide coverage, however.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://www.usgs.gov/core-science-systems/ngp/topo-maps/historical-topographic-map-collection?qt-science_support_page_related_con=0&quot;&gt;USGS Historical Topographic Maps&lt;/a&gt;: 181,000 topographic maps, created between 1884 and 2006, covering U.S. territory. These files have been scanned, georeferenced, and saved in COG format in a public S3 bucket.&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;NAIP, MODIS, and CBERS imagery is stored in requester-pays buckets, which means
that the requester pays the cost of the &lt;code&gt;GET&lt;/code&gt; request and the data transfer, but
as we&amp;#x27;ll see in future blog posts, this is a small cost as long as the tiler is
located in the same region as the data.&lt;/p&gt;&lt;p&gt;Additionally, high-resolution USGS elevation data &lt;a href=&quot;https://www.usgs.gov/news/usgs-digital-elevation-models-dem-switching-new-distribution-format&quot;&gt;is being
converted&lt;/a&gt; to COG, with expected launch in 2020, and there are
rumors that Sentinel 2 data may be available in COG in the future.&lt;/p&gt;&lt;h2 id=&quot;mosaicjson&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#mosaicjson&quot; aria-label=&quot;mosaicjson permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;MosaicJSON&lt;/h2&gt;&lt;p&gt;It&amp;#x27;s great that all those terabytes of COG exist for public consumption, but you
still need a way to select what portions of imagery to combine. That&amp;#x27;s where
&lt;a href=&quot;https://github.com/developmentseed/mosaicjson-spec&quot;&gt;MosaicJSON&lt;/a&gt; comes in. It&amp;#x27;s a file that determines what source files
should be merged to create each web mercator map tile.&lt;/p&gt;&lt;p&gt;MosaicJSON files add flexibility to the system. I can switch combinations of
imagery by switching the MosaicJSON file that I pass to the tiler. For example,
I&amp;#x27;ve generated a couple dozen MosaicJSON files representing cloudless Landsat 8
combinations: one per season since 2013. It&amp;#x27;s then easy to expose image
selection options to the user by changing the MosaicJSON url to give to the
tiler. (Deeper explanation coming in future blog post).&lt;/p&gt;&lt;h2 id=&quot;serverless-computing&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#serverless-computing&quot; aria-label=&quot;serverless computing permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Serverless Computing&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Serverless_computing&quot;&gt;Serverless computing&lt;/a&gt; is the last part of the puzzle.
With services like AWS Lambda, one can set up dynamic tiling for a hobby
project, and never have to manage servers. AWS Lambda will scale up and down
with demand. If your project generally receives little traffic, but once in a
while goes viral, you pay very little when you have no visitors, but are still
able to scale quickly to whatever level is necessary.&lt;/p&gt;&lt;p&gt;To be clear, going serverless is not a &lt;em&gt;necessary&lt;/em&gt; part of the puzzle. If you
plan to serve map tiles at scale, it may be more performant or cheaper to
maintain your own servers, but the maintainance overhead needs to be taken into
account.&lt;/p&gt;&lt;p&gt;At this stage, I plan to use dynamic tiling for hobby projects, and not having
to manage servers is a big plus.&lt;/p&gt;&lt;p&gt;While serverless computing is sometimes more expensive than running and
maintaining a server, serving tiles is still cheaper than some paid services. A
rough cost estimate for on-demand tiling of Landsat 8 data is $50 per million
tiles. As a comparison, once (if) you surpass Mapbox&amp;#x27;s (very generous) free
tier, their pricing is $0.25 per 1000 requests, or $250 per million.
Furthermore, I aggressively &lt;a href=&quot;/blog/caching-lambda-functions-cloudflare&quot;&gt;cache my Lambda responses with
Cloudflare&lt;/a&gt; to minimize the requests that reach the origin.&lt;/p&gt;&lt;p&gt;But overall, part of the allure of dynamic tiling is the flexibility from being
able to choose &lt;em&gt;any&lt;/em&gt; imagery on demand. You aren&amp;#x27;t restricted to what Mapbox
selects for their satellite basemap.&lt;/p&gt;&lt;h2 id=&quot;ecosystem&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#ecosystem&quot; aria-label=&quot;ecosystem permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Ecosystem&lt;/h2&gt;&lt;p&gt;Over the last few months, and along with &lt;a href=&quot;https://twitter.com/_vincents_&quot;&gt;Vincent Sarago&lt;/a&gt; and
&lt;a href=&quot;https://github.com/geospatial-jeff&quot;&gt;Jeff Albrecht&lt;/a&gt;, I&amp;#x27;ve been helping to build out an ecosystem of
open source tools to make dynamic tiling fast and reliable.&lt;/p&gt;&lt;p&gt;There are several interrelated tools. It&amp;#x27;s easy to get them confused.&lt;/p&gt;&lt;p&gt;Here&amp;#x27;s an overview of the ecosystem.&lt;/p&gt;&lt;h3 id=&quot;rio-tiler&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#rio-tiler&quot; aria-label=&quot;rio tiler permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;code&gt;rio-tiler&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/cogeotiff/rio-tiler&quot;&gt;&lt;code&gt;rio-tiler&lt;/code&gt;&lt;/a&gt; is at the core of the ecosystem. It&amp;#x27;s a library whose
main purpose is to create a mercator tile from a given input image. In contrast
to some of the following libraries, it takes a &lt;em&gt;single&lt;/em&gt; input path and returns a
&lt;em&gt;single&lt;/em&gt; output image. It forms the core of some other libraries.&lt;/p&gt;&lt;p&gt;With the &amp;quot;standard&amp;quot; tiler, you provide a path to a COG image and a standard
&lt;code&gt;xyz&lt;/code&gt; mercator tile, and it returns data for that mercator tile. Specifically,
it returns &lt;em&gt;two objects&lt;/em&gt;, &lt;code&gt;data&lt;/code&gt; and &lt;code&gt;mask&lt;/code&gt;, which allow you to ascertain what
portions of the mercator tile are not covered by the source image. &lt;code&gt;rio-tiler&lt;/code&gt;
also includes some &amp;quot;mission-specific&amp;quot; tilers for Landsat 8, Sentinel 1 and 2,
and CBERS. These allow you to pass an &lt;em&gt;identifier&lt;/em&gt; to a satellite scene, and the
tiler will find the data corresponding to that scene on AWS S3.&lt;/p&gt;&lt;p&gt;&lt;em&gt;September 2020 update&lt;/em&gt;: With the upcoming &lt;code&gt;rio-tiler&lt;/code&gt; v2.0 release,
mission-specific tilers have been refactored into a separate module,
&lt;a href=&quot;https://github.com/cogeotiff/rio-tiler-pds&quot;&gt;&lt;code&gt;rio-tiler-pds&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;&lt;h3 id=&quot;rio-tiler-mosaic&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#rio-tiler-mosaic&quot; aria-label=&quot;rio tiler mosaic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;code&gt;rio-tiler-mosaic&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/cogeotiff/rio-tiler-mosaic&quot;&gt;&lt;code&gt;rio-tiler-mosaic&lt;/code&gt;&lt;/a&gt; builds upon &lt;code&gt;rio-tiler&lt;/code&gt; to work with
multiple assets. It takes a list of assets that are &lt;em&gt;already known&lt;/em&gt; to overlap
with the tile, and combines them into an image aligned with a web mercator tile.&lt;/p&gt;&lt;p&gt;This is a core difference between this and &lt;code&gt;cogeo-mosaic&lt;/code&gt;/&lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt;:
since &lt;code&gt;rio-tiler-mosaic&lt;/code&gt; doesn&amp;#x27;t interact with the MosaicJSON directly,
&lt;code&gt;rio-tiler-mosaic&lt;/code&gt; doesn&amp;#x27;t know how to &lt;em&gt;find&lt;/em&gt; the right combination of assets to
tile together.&lt;/p&gt;&lt;p&gt;&lt;code&gt;rio-tiler-mosaic&lt;/code&gt; takes a &lt;em&gt;tiler&lt;/em&gt; from &lt;code&gt;rio-tiler&lt;/code&gt; as an argument. This forms a
simple plugin system, making it simple to create an image tile from either the
standard tiler or a mission-specific tiler, such as the Landsat 8 tiler.&lt;/p&gt;&lt;p&gt;&lt;em&gt;September 2020 update&lt;/em&gt;: With the upcoming &lt;code&gt;rio-tiler&lt;/code&gt; v2.0 release,
&lt;code&gt;rio-tiler-mosaic&lt;/code&gt; is merged into the main &lt;code&gt;rio-tiler&lt;/code&gt; repository.&lt;/p&gt;&lt;h3 id=&quot;cogeo-mosaic&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#cogeo-mosaic&quot; aria-label=&quot;cogeo mosaic permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;code&gt;cogeo-mosaic&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic&quot;&gt;&lt;code&gt;cogeo-mosaic&lt;/code&gt;&lt;/a&gt; is a Python library to create MosaicJSON files
and load such files from various &lt;em&gt;backends&lt;/em&gt;. In the upcoming 3.0 release, new
support exists for storing a MosaicJSON in a variety of locations, including in
a DynamoDB table. For large mosaics, DynamoDB is significantly faster than
loading a JSON file from an S3 bucket.&lt;/p&gt;&lt;h3 id=&quot;cogeo-mosaic-tiler&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#cogeo-mosaic-tiler&quot; aria-label=&quot;cogeo mosaic tiler permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic-tiler&quot;&gt;&lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt;&lt;/a&gt; wraps all of the above together. It&amp;#x27;s
a python package and web server that depends on the above packages to serve
tiled imagery on demand, and is designed to be deployed on AWS Lambda.&lt;/p&gt;&lt;p&gt;For example, the image endpoint essentially just loads a given MosaicJSON using
&lt;code&gt;cogeo-mosaic&lt;/code&gt;, using it to find asset identifiers for a specific mercator tile.
Then it passes those assets to &lt;code&gt;rio-tiler-mosaic&lt;/code&gt; using the standard tiler from
&lt;code&gt;rio-tiler&lt;/code&gt;. Those two packages then load each of the necessary assets,
combining them into a single web mercator tile on the fly, returning it as an
image to the user.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/developmentseed/awspds-mosaic&quot;&gt;&lt;code&gt;awspds-mosaic&lt;/code&gt;&lt;/a&gt; is a fork of &lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt; to support
dynamic tiling of Landsat 8 data stored on AWS as a public data set. Landsat 8
imagery has some custom needs because data are stored in individual bands that
need to be combined into a single image.&lt;/p&gt;&lt;p&gt;&lt;em&gt;September 2020 update&lt;/em&gt;: &lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt; is being superseded by
&lt;a href=&quot;https://github.com/developmentseed/titiler&quot;&gt;&lt;code&gt;titiler&lt;/code&gt;&lt;/a&gt;, a newer dynamic tiling server that handles more use-cases
and has more varied options for deployment. I recommend titiler for all new
deployments, as &lt;code&gt;cogeo-mosaic-tiler&lt;/code&gt; is less likely to receive updates.&lt;/p&gt;&lt;h3 id=&quot;rio-cogeo&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#rio-cogeo&quot; aria-label=&quot;rio cogeo permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;code&gt;rio-cogeo&lt;/code&gt;&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/cogeotiff/rio-cogeo&quot;&gt;&lt;code&gt;rio-cogeo&lt;/code&gt;&lt;/a&gt; is a library to facilitate &lt;em&gt;creating COGs&lt;/em&gt;. It&amp;#x27;s rare
that I use it because I&amp;#x27;m generally tiling COGs that already exist publicly on
S3, and thus I don&amp;#x27;t need to create new COGs.&lt;/p&gt;&lt;h2 id=&quot;references&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#references&quot; aria-label=&quot;references permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://medium.com/devseed/cog-talk-part-1-whats-new-941facbcd3d1&quot;&gt;COG talk&lt;/a&gt;, a great, insightful series on the Cloud-Optimized GeoTIFF format, MosaicJSON, and dynamic tiling.&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Dynamic map tiling USGS Historical Topo Maps]]></title><link>https://kylebarron.dev/blog/cog-mosaic/usgs-topo-maps</link><guid isPermaLink="false">https://kylebarron.dev/blog/cog-mosaic/usgs-topo-maps</guid><pubDate>Fri, 08 May 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:57.91666666666667%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAABA//EABcBAAMBAAAAAAAAAAAAAAAAAAABAgP/2gAMAwEAAhADEAAAAXoOrC8uUL//xAAYEAADAQEAAAAAAAAAAAAAAAAAATICMf/aAAgBAQABBQJVqTPXJ//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/AWf/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAYEAEAAwEAAAAAAAAAAAAAAAABABAhMf/aAAgBAQABPyFZajnaNKDP/9oADAMBAAIAAwAAABDgz//EABYRAQEBAAAAAAAAAAAAAAAAAAARMf/aAAgBAwEBPxDSP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAAIDAQEAAAAAAAAAAAAAAAERACExUUH/2gAIAQEAAT8QOXBtxC3CL5BbAC72CHPrgW+OIGA3P//Z&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Historical Map of Death Valley&quot; title=&quot;Historical Map of Death Valley&quot; src=&quot;/static/a3aefbb25665ee7ccdd97f8db921d30c/18e3b/death_valley_hist.jpg&quot; srcSet=&quot;/static/a3aefbb25665ee7ccdd97f8db921d30c/46946/death_valley_hist.jpg 240w,/static/a3aefbb25665ee7ccdd97f8db921d30c/55489/death_valley_hist.jpg 480w,/static/a3aefbb25665ee7ccdd97f8db921d30c/18e3b/death_valley_hist.jpg 960w,/static/a3aefbb25665ee7ccdd97f8db921d30c/60e21/death_valley_hist.jpg 1440w,/static/a3aefbb25665ee7ccdd97f8db921d30c/c6ff8/death_valley_hist.jpg 1491w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Cache AWS Lambda responses with Cloudflare]]></title><link>https://kylebarron.dev/blog/caching-lambda-functions-cloudflare</link><guid isPermaLink="false">https://kylebarron.dev/blog/caching-lambda-functions-cloudflare</guid><pubDate>Mon, 27 Apr 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;&lt;a href=&quot;https://www.cloudflare.com/&quot;&gt;Cloudflare&lt;/a&gt; is a Content Delivery Network (CDN), a global network
of servers that cache responses from websites so that those responses can load
more quickly for future website visitors. A CDN has dual benefits: your website
becomes faster for your visitors, but &lt;em&gt;also&lt;/em&gt; fewer traffic reaches your origin
web server, reducing load. For Cloudflare specifically, they have a generous
free tier, so for most personal projects, it&amp;#x27;s more than enough for my needs.&lt;/p&gt;&lt;p&gt;I&amp;#x27;m building some projects around AWS Lambda, a powerful serverless platform
that allows you to respond to network requests in a completely scalable way.
When your traffic is zero, your costs are zero, but if your website goes viral,
you&amp;#x27;ll be able to scale to a huge number of requests quickly.&lt;/p&gt;&lt;p&gt;Cloudflare is especially helpful alongside AWS Lambda because pricing is done
per request, so the fewer requests that reach your Lambda function, the cheaper
it&amp;#x27;ll be to run.&lt;/p&gt;&lt;p&gt;This post is a high-level overview of how to connect Lambda and Cloudflare.&lt;/p&gt;&lt;h3 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/a/45849093&quot;&gt;This StackOverflow answer&lt;/a&gt; on connecting API Gateway
to Cloudflare is extremely helpful, so much of this post is essentially
rehashing that answer for my future reference.&lt;/p&gt;&lt;h4 id=&quot;set-up-cloudflare&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#set-up-cloudflare&quot; aria-label=&quot;set up cloudflare permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Set up Cloudflare&lt;/h4&gt;&lt;p&gt;First you need to set up a Cloudflare account and attach a domain you own. This
is relatively self-explanatory. Go to &lt;a href=&quot;https://cloudflare.com&quot;&gt;https://cloudflare.com&lt;/a&gt;, sign up, and
follow their instructions for attaching your domain name and pointing your DNS
towards Cloudflare&amp;#x27;s nameservers.&lt;/p&gt;&lt;h4 id=&quot;create-certificate&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#create-certificate&quot; aria-label=&quot;create certificate permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Create certificate&lt;/h4&gt;&lt;p&gt;Since API Gateway requires all outbound traffic to be encrypted, you need to
create an SSL certificate to upload to AWS to tell how to encrypt your data. The
simplest way to create this certificate is through the Cloudflare dashboard.
Cloudflare will helpfully also renew the certificate as needed.&lt;/p&gt;&lt;p&gt;Go to your website in Cloudflare&amp;#x27;s UI and then choose &amp;quot;SSL/TLS&amp;quot; &amp;gt; &amp;quot;Origin
Server&amp;quot;. Then click &amp;quot;Create Certificate&amp;quot;.&lt;/p&gt;&lt;p&gt;The only thing you need to change is the hostnames field. Since I&amp;#x27;ll put my
endpoints at &lt;code&gt;lambda.kylebarron.dev/*&lt;/code&gt;, I enter the following hostnames:&lt;/p&gt;&lt;p&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:23.333333333333332%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA3ElEQVQY022QyW6DQBBE5/8/K5ZixQth33cwWLFBYj9Wujux5YMPT9VT1VODUEEYwvN9wQ8C2I4j6riueGEUCa7nic+87rPPc14UuHcdlGGacvmBZdtS6tIsShfYNy0LJu0eTyecNQ26YUj2reuil6bBz+0G9bHb4XO/x9fh8Bf+F3EBlzP8elXXSLMMWZ6LPuYkTWXmnfZ6hSqrCmVZilGQNm0rFFzCGcGvD+OIbduwritW1teZlRinCSqKYyRJ8qSmL+GSiP4bn2PKY9Ku77EsC6Z5fstM2TCM+AUweGlTBdmpagAAAABJRU5ErkJggg==&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;certificate_hostnames.png&quot; title=&quot;certificate_hostnames.png&quot; src=&quot;/static/3448422cb543469b810dc33a870e9093/7d769/certificate_hostnames.png&quot; srcSet=&quot;/static/3448422cb543469b810dc33a870e9093/5243c/certificate_hostnames.png 240w,/static/3448422cb543469b810dc33a870e9093/ab158/certificate_hostnames.png 480w,/static/3448422cb543469b810dc33a870e9093/7d769/certificate_hostnames.png 960w,/static/3448422cb543469b810dc33a870e9093/87339/certificate_hostnames.png 1440w,/static/3448422cb543469b810dc33a870e9093/3557b/certificate_hostnames.png 1692w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/p&gt;&lt;p&gt;Upon continuing, you see the generated certificate. It&amp;#x27;s crypto gibberish, but
you should keep a record of this, but for the next few steps, and possibly
longer term in your password manager.&lt;/p&gt;&lt;h4 id=&quot;import-certificate&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#import-certificate&quot; aria-label=&quot;import certificate permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Import Certificate&lt;/h4&gt;&lt;p&gt;Navigate to the AWS Certificate Manager (ACM) console. This should be easily
found through the AWS web UI.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: In general, you should upload to &lt;code&gt;us-east-1&lt;/code&gt;. However, I&amp;#x27;m using the
newer, cheaper HTTP API Gateway endpoint instead of the older REST API Gateway
endpoint. For the HTTP API Gateway endpoints, &lt;strong&gt;the certificate needs to be
uploaded to ACM in the same region as the lambda functions&lt;/strong&gt;. I also don&amp;#x27;t
think there&amp;#x27;s a downside to uploading your certificate to multiple regions.&lt;/p&gt;&lt;p&gt;Click &amp;quot;Import Certificate&amp;quot;. Then where it says &amp;quot;Certificate body&amp;quot;, paste your
&lt;strong&gt;Origin Certificate&lt;/strong&gt; from the previous step. Where it says &amp;quot;Certificate
private key&amp;quot;, paste your &lt;strong&gt;Private key&lt;/strong&gt; from the previous step. For the
&amp;quot;Certificate chain&amp;quot;, that&amp;#x27;s a special public key from Cloudflare. To retrieve
it, go to &lt;a href=&quot;https://support.cloudflare.com/hc/en-us/articles/115000479507&quot;&gt;this Cloudflare help page&lt;/a&gt;, scroll down to &amp;quot;Step 4 -
Add Cloudflare Origin CA root certificates&amp;quot;, and expand &amp;quot;Cloudflare Origin CA —
RSA Root&amp;quot;. Then paste that value into the AWS ACM box. Click &amp;quot;Next&amp;quot;. Add a tag
if you&amp;#x27;d like, then click &amp;quot;Import&amp;quot;.&lt;/p&gt;&lt;h4 id=&quot;add-custom-domain-to-api-gateway&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#add-custom-domain-to-api-gateway&quot; aria-label=&quot;add custom domain to api gateway permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Add custom domain to API Gateway&lt;/h4&gt;&lt;p&gt;Go to the API Gateway console. Then choose &amp;quot;Custom Domain Names&amp;quot; on the left.
Then click &amp;quot;Create&amp;quot;. Enter your domain name, which must match the one provided
when you created the certificate. Since I use this for personal projects, I&amp;#x27;m
content with &amp;quot;Regional&amp;quot;, which likely has lower availability than
&amp;quot;Edge-optimized&amp;quot;, but is still very high. Then choose the ACM certificate you
just uploaded that also matches the same domain name. Then click &amp;quot;Create&amp;quot;.&lt;/p&gt;&lt;h4 id=&quot;configure-domain-mappings&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#configure-domain-mappings&quot; aria-label=&quot;configure domain mappings permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Configure domain mappings&lt;/h4&gt;&lt;p&gt;Now you&amp;#x27;ve created a certificate, imported it to Amazon, and connected it with a
custom API gateway domain. But you need to tell API Gateway which API to call
when that domain is requested. On the same page as the last step, click
&amp;quot;Configure API mappings&amp;quot;, then &amp;quot;Add new mapping&amp;quot;. Use the boxes to associate
paths to APIs and then click &amp;quot;Save&amp;quot;. Note that if the path is &lt;code&gt;/endpoint&lt;/code&gt;,
you&amp;#x27;ll reach that API by calling &lt;code&gt;your_domain/endpoint&lt;/code&gt;.&lt;/p&gt;&lt;h4 id=&quot;connect-cloudflare-to-that-api-gateway-domain&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#connect-cloudflare-to-that-api-gateway-domain&quot; aria-label=&quot;connect cloudflare to that api gateway domain permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Connect Cloudflare to that API Gateway domain&lt;/h4&gt;&lt;p&gt;Now you need to tell Cloudflare to route traffic from your custom domain name to
API Gateway. Make note of the &amp;quot;API Gateway domain name&amp;quot; on the API Gateway page
where you just added a custom domain. Then go back to the Cloudflare dashboard
and click the &amp;quot;DNS&amp;quot; tab. Then add a &lt;strong&gt;&lt;code&gt;CNAME&lt;/code&gt;&lt;/strong&gt; record, where &amp;quot;Name&amp;quot; is the
subdomain name, and &amp;quot;Target&amp;quot; is that &amp;quot;API Gateway domain name&amp;quot;. Click &amp;quot;Save&amp;quot;.&lt;/p&gt;&lt;h4 id=&quot;set-ssl-to-full-strict&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#set-ssl-to-full-strict&quot; aria-label=&quot;set ssl to full strict permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Set SSL to Full (Strict)&lt;/h4&gt;&lt;p&gt;Last, you need to set your SSL mode to &amp;quot;Full (Strict)&amp;quot;. If you&amp;#x27;re ok with the
&lt;em&gt;entire domain&lt;/em&gt; being &amp;quot;Full (Strict)&amp;quot;, you can go to &amp;quot;SSL/TLS&amp;quot; and switch the
encryption mode to &amp;quot;Full (Strict)&amp;quot;.&lt;/p&gt;&lt;p&gt;I use the same base domain for traffic served directly from S3. Since S3 doesn&amp;#x27;t
support HTTPS traffic, I need to have Cloudflare&amp;#x27;s SSL setting set to Flexible,
which means that traffic is encrypted between the user and Cloudflare, but not
between Cloudflare and S3. However I need to serve traffic to AWS API Gateway
with HTTPS.&lt;/p&gt;&lt;p&gt;To get around this, I add a Cloudflare page rule, so that just this API Gateway
traffic is set to &amp;quot;Full (Strict)&amp;quot;. Click the &amp;quot;Page Rules&amp;quot; tab, click &amp;quot;Create
Page Rule&amp;quot;, add a string matching your domain name(s). Then choose &amp;quot;SSL&amp;quot; as the
setting, and set the setting to &amp;quot;Full (Strict)&amp;quot;. Then click &amp;quot;Save and Deploy&amp;quot;.&lt;/p&gt;&lt;h3 id=&quot;conclusion&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h3&gt;&lt;p&gt;You should now be able to access your API endpoint through your custom domain!
In order for Cloudflare to cache your content, you need to set applicable
&lt;code&gt;Cache-Control&lt;/code&gt; headers, such as &lt;code&gt;public,max-age=3600&lt;/code&gt;, to cache on both a
user&amp;#x27;s browser and on Cloudflare&amp;#x27;s server for a period of 1 hour. If the file
extension is not one &lt;a href=&quot;https://support.cloudflare.com/hc/en-us/articles/200172516-Understanding-Cloudflare-s-CDN#h_a01982d4-d5b6-4744-bb9b-a71da62c160a&quot;&gt;cached by default&lt;/a&gt;, you&amp;#x27;ll need to set
a &amp;quot;Cache Everything&amp;quot; page rule.&lt;/p&gt;&lt;p&gt;In order to find out if any given request was served from Cloudflare&amp;#x27;s cache,
you can inspect the &lt;code&gt;cf-cache-status&lt;/code&gt; header on the response. If the value is
&lt;code&gt;HIT&lt;/code&gt;, the asset was served from Cloudflare&amp;#x27;s cache.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Footnotes&lt;/strong&gt;:&lt;/p&gt;&lt;p&gt;If you use the HTTP API endpoints, you need the certificate to be in &lt;em&gt;the same
region&lt;/em&gt; as the API. However that also means that if you have HTTP API&amp;#x27;s in two
separate regions, you can&amp;#x27;t use one domain for both. You&amp;#x27;ll have to create a
separate domain for each region. For the Cloudflare page rule, set an asterisk
like &lt;code&gt;*lambda.domain&lt;/code&gt;, so that you can use one page rule for all subdomains.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Protect self-hosted assets with firewalls and CORS]]></title><link>https://kylebarron.dev/protect-self-hosted-assets-with-firewalls-and-cors</link><guid isPermaLink="false">https://kylebarron.dev/protect-self-hosted-assets-with-firewalls-and-cors</guid><pubDate>Fri, 24 Apr 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;I self host map tiles and other large assets for use by my own projects, but in
general I don&amp;#x27;t want to host map data for anyone on the internet. By default,
hosting a server with map tiles open to the internet means that anyone could
point to your URL and serve a web map using your map data.&lt;/p&gt;&lt;p&gt;I&amp;#x27;ve created open-source scripts [] to generate map tiles, in order to enable
developers to self host map assets as easily as possible, but I don&amp;#x27;t want to
pay for them to use my tiles directly.&lt;/p&gt;&lt;p&gt;I host my map assets partially on a Google Cloud f1-micro instance, and
partially on AWS S3 directly. For both, I put Cloudflare in front so that I can
benefit from their caching and lower my bandwidth costs.&lt;/p&gt;&lt;h2 id=&quot;allow-only-traffic-from-cloudflare&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#allow-only-traffic-from-cloudflare&quot; aria-label=&quot;allow only traffic from cloudflare permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Allow only traffic from Cloudflare&lt;/h2&gt;&lt;p&gt;I use Cloudflare to make load times faster for users through their CDN, and to
keep my bandwidth costs as low as possible by leveraging their free caching.
However, this strategy only works if all your traffic is indeed coming through
Cloudflare.&lt;/p&gt;&lt;p&gt;Both AWS S3 and a Google Cloud Compute instance have default URLs for access.
For S3, if you create the bucket in US-East-1, it&amp;#x27;ll be
&lt;code&gt;https://s3.amazonaws.com/BUCKET_NAME&lt;/code&gt;. For Google Cloud, it&amp;#x27;s the external IP
address. Traffic coming directly to either of those won&amp;#x27;t be proxied by
Cloudflare, and thus won&amp;#x27;t be cached. The solution is to only allow access from
Cloudflare&amp;#x27;s IP addresses, because when Cloudflare proxies traffic for you, it
means that your server sees Cloudflare&amp;#x27;s IP address as the source, instead of
the user&amp;#x27;s.&lt;/p&gt;&lt;p&gt;You&amp;#x27;ll need to first get &lt;a href=&quot;https://www.cloudflare.com/ips&quot;&gt;the list&lt;/a&gt; of all the
IP addresses Cloudflare uses for proxy traffic, which will be used in the next
steps.&lt;/p&gt;&lt;h3 id=&quot;s3&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#s3&quot; aria-label=&quot;s3 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;S3&lt;/h3&gt;&lt;p&gt;For S3, you can restrict traffic to only traffic from Cloudflare by creating a
&lt;em&gt;bucket policy&lt;/em&gt;. To do this, go to the Amazon S3 console, choose your bucket,
click &amp;quot;Permissions&amp;quot;, then click &amp;quot;Bucket Policy&amp;quot;. You&amp;#x27;ll then be greeted by a
text editor, where you can add a bucket policy.&lt;/p&gt;&lt;p&gt;The following bucket policy allows the action &lt;code&gt;s3:GetObject&lt;/code&gt;--aka HTTP GET
requests--to all objects in your bucket, given that the source IP address is
within one of the addresses listed in &lt;code&gt;aws:SourceIp&lt;/code&gt;. The IP addresses listed
are currently all the IP addresses Cloudflare uses.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-json:title=bucket_policy.json&quot;&gt;{
  &amp;quot;Version&amp;quot;: &amp;quot;2012-10-17&amp;quot;,
  &amp;quot;Statement&amp;quot;: [
    {
      &amp;quot;Sid&amp;quot;: &amp;quot;PublicReadGetObject&amp;quot;,
      &amp;quot;Effect&amp;quot;: &amp;quot;Allow&amp;quot;,
      &amp;quot;Principal&amp;quot;: &amp;quot;*&amp;quot;,
      &amp;quot;Action&amp;quot;: &amp;quot;s3:GetObject&amp;quot;,
      &amp;quot;Resource&amp;quot;: &amp;quot;arn:aws:s3:::BUCKET_NAME/*&amp;quot;,
      &amp;quot;Condition&amp;quot;: {
        &amp;quot;IpAddress&amp;quot;: {
          &amp;quot;aws:SourceIp&amp;quot;: [
            &amp;quot;2400:cb00::/32&amp;quot;,
            &amp;quot;2405:8100::/32&amp;quot;,
            &amp;quot;2405:b500::/32&amp;quot;,
            &amp;quot;2606:4700::/32&amp;quot;,
            &amp;quot;2803:f800::/32&amp;quot;,
            &amp;quot;2c0f:f248::/32&amp;quot;,
            &amp;quot;2a06:98c0::/29&amp;quot;,
            &amp;quot;103.21.244.0/22&amp;quot;,
            &amp;quot;103.22.200.0/22&amp;quot;,
            &amp;quot;103.31.4.0/22&amp;quot;,
            &amp;quot;104.16.0.0/12&amp;quot;,
            &amp;quot;108.162.192.0/18&amp;quot;,
            &amp;quot;131.0.72.0/22&amp;quot;,
            &amp;quot;141.101.64.0/18&amp;quot;,
            &amp;quot;162.158.0.0/15&amp;quot;,
            &amp;quot;172.64.0.0/13&amp;quot;,
            &amp;quot;173.245.48.0/20&amp;quot;,
            &amp;quot;188.114.96.0/20&amp;quot;,
            &amp;quot;190.93.240.0/20&amp;quot;,
            &amp;quot;197.234.240.0/22&amp;quot;,
            &amp;quot;198.41.128.0/17&amp;quot;
          ]
        }
      }
    }
  ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Once you save the bucket policy, all objects will only be accessible through
Cloudflare. For example, if I put an &lt;code&gt;index.html&lt;/code&gt; at the root of my bucket, and
attempt to load it by its default AWS S3 URL
(&lt;code&gt;https://s3.amazonaws.com/BUCKET_NAME/index.html&lt;/code&gt;), I&amp;#x27;m greeted with
&amp;quot;AccessDenied&amp;quot;:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot;&gt;&amp;lt;Error&amp;gt;
  &amp;lt;Code&amp;gt;AccessDenied&amp;lt;/Code&amp;gt;
  &amp;lt;Message&amp;gt;Access Denied&amp;lt;/Message&amp;gt;
  &amp;lt;RequestId&amp;gt;EBD7E77186227632&amp;lt;/RequestId&amp;gt;
  &amp;lt;HostId&amp;gt;
    JhPjXJKGdWUbP14jkhti8RdkenxGyG8+zm1h9Cew/hOkiYIiXKpQ3uCA1OTJVO5wBcxwAvqZq/s=
  &amp;lt;/HostId&amp;gt;
&amp;lt;/Error&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;However, after pointing Cloudflare to the bucket, I can succesfully access that
file (&lt;code&gt;https://CLOUDFLARE_URL/index.html&lt;/code&gt;):&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Hello world!
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;google-cloud-compute-engine&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#google-cloud-compute-engine&quot; aria-label=&quot;google cloud compute engine permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Google Cloud Compute Engine&lt;/h3&gt;&lt;p&gt;You can also restrict your Google Cloud Compute Engine instance to only accept traffic
from Cloudflare IP addresses. Go to the &lt;a href=&quot;https://console.cloud.google.com/networking/firewalls/list&quot;&gt;Firewall
rules&lt;/a&gt; page in
Google Cloud Console for project. Then select &amp;quot;Create Firewall Rule&amp;quot;. Give it a
name and description; I like &lt;code&gt;cloudflare-allow-http-https&lt;/code&gt;. Keep &amp;quot;Direction&amp;quot; as
&amp;quot;Ingress&amp;quot;, since you&amp;#x27;re restricting inbound traffic. Set &amp;quot;Action on match&amp;quot; to
&amp;quot;Allow&amp;quot;. &amp;quot;Targets&amp;quot; allows you to set this Firewall rule for all compute units in
your account or just selected ones. Since I also have compute units under the
same project that shouldn&amp;#x27;t receive HTTP traffic, I add a target tag to the
firewall, and also add the same target tag to the compute instance to which I
want to allow traffic.&lt;/p&gt;&lt;p&gt;For &amp;quot;Source filter&amp;quot;, keep it as &amp;quot;IP ranges&amp;quot;, then add the list of Cloudflare&amp;#x27;s
source IP ranges. Annoyingly, this apparently must be done one at a time. Also,
I got errors when trying to add Cloudflare&amp;#x27;s IPv6 addresses, so I only added its
IPv4 addresses and it appears to work fine. The IPv4 addresses are the ones of
the form &lt;code&gt;[0-255].[0-255].[0-255].[0-255]&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;For &amp;quot;Protocols and ports&amp;quot;, choose &amp;quot;Specified protocols and ports&amp;quot;, and set &lt;code&gt;tcp&lt;/code&gt;
to &lt;code&gt;80,443&lt;/code&gt;, which are the ports used for HTTP and HTTPS traffic.&lt;/p&gt;&lt;p&gt;Then click &amp;quot;Create&amp;quot; and wait for the rule to be created.&lt;/p&gt;&lt;p&gt;If you added a &amp;quot;Target tag&amp;quot; in the firewall, don&amp;#x27;t forget to go back to the VM
instance, choose &amp;quot;Edit&amp;quot;, and add that tag under &amp;quot;Network tags&amp;quot;.&lt;/p&gt;&lt;p&gt;You should be able to test that the firewall is working correctly by attempting
to navigate to the instance&amp;#x27;s external IP address in your browser. It should
timeout.&lt;/p&gt;&lt;h2 id=&quot;cors&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#cors&quot; aria-label=&quot;cors permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;CORS&lt;/h2&gt;&lt;p&gt;From the &lt;a href=&quot;https://support.cloudflare.com/hc/en-us/articles/200308847-Using-cross-origin-resource-sharing-CORS-with-Cloudflare#4vknA9IbgW57oiclaPv4QP&quot;&gt;Cloudflare documentation&lt;/a&gt;, there are three options to make Cloudflare&amp;#x27;s cache see your updated CORS headers:&lt;/p&gt;&lt;blockquote&gt;&lt;ul&gt;&lt;li&gt;Change the filename or URL to bypass cache to instruct Cloudflare to retrieve the latest CORS headers.&lt;/li&gt;&lt;li&gt;Use the single-file purge API to specify the appropriate CORS headers along with the purge request&lt;/li&gt;&lt;li&gt;Update the resource’s last-modified time at your origin web server. Then, complete a full purge to retrieve the latest version of your assets including updated CORS headers&lt;/li&gt;&lt;/ul&gt;&lt;/blockquote&gt;&lt;p&gt;Each of these options is difficult. For the first, you need to change all your
filenames, which can be a burden on S3. The second implies you need to purge
every file individually through their API, which could take a while and be easy
to miss some files.&lt;/p&gt;&lt;p&gt;The overall lesson here is to &lt;em&gt;minimize CORS header changes&lt;/em&gt;. It&amp;#x27;s much easier
to set up the first time than to change. If you&amp;#x27;re constantly creating new
domain names that you want to access your map data from, you might want to have
a more open CORS configuration, so that you don&amp;#x27;t need to go through one of
these steps on every new domain.&lt;/p&gt;&lt;h3 id=&quot;aws-s3&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#aws-s3&quot; aria-label=&quot;aws s3 permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AWS S3&lt;/h3&gt;&lt;p&gt;By default, a bucket&amp;#x27;s CORS configuration is empty. This means that only
requests from the same domain will be accepted. You can test this with
&lt;code&gt;fetch(URL)&lt;/code&gt; in the browser console. If you go to a different domain, say,
&lt;code&gt;https://google.com&lt;/code&gt;, and then try:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot;&gt;fetch(&amp;quot;https://CLOUDFLARE_URL/index.html&amp;quot;);
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;you&amp;#x27;ll see an error message like:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;Access to fetch at &amp;#x27;https://CLOUDFLARE_URL/index.html&amp;#x27; from origin
&amp;#x27;https://www.google.com&amp;#x27; has been blocked by CORS policy: No
&amp;#x27;Access-Control-Allow-Origin&amp;#x27; header is present on the requested resource. If an
opaque response serves your needs, set the request&amp;#x27;s mode to &amp;#x27;no-cors&amp;#x27; to fetch
the resource with CORS disabled.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;while if you go to the same domain, say &lt;code&gt;https://CLOUDFLARE_URL/index.html&lt;/code&gt;, and
then try the request again &lt;code&gt;fetch(&amp;#x27;https://CLOUDFLARE_URL/index.html&amp;#x27;)&lt;/code&gt;, it&amp;#x27;ll
go through because the request was coming from the same address.&lt;/p&gt;&lt;p&gt;If you wanted to allow &lt;em&gt;every website&lt;/em&gt; to load content from your bucket, you
could add a CORS configuration like the following:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&amp;lt;CORSConfiguration&amp;gt;
&amp;lt;CORSRule&amp;gt;
    &amp;lt;AllowedOrigin&amp;gt;*&amp;lt;/AllowedOrigin&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;GET&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;HEAD&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;MaxAgeSeconds&amp;gt;3000&amp;lt;/MaxAgeSeconds&amp;gt;
    &amp;lt;AllowedHeader&amp;gt;*&amp;lt;/AllowedHeader&amp;gt;
&amp;lt;/CORSRule&amp;gt;
&amp;lt;/CORSConfiguration&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I only want &lt;em&gt;selected websites&lt;/em&gt; to be able to load my content, so I can instead
use a CORS configuration like the following:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-xml&quot;&gt;&amp;lt;?xml version=&amp;quot;1.0&amp;quot; encoding=&amp;quot;UTF-8&amp;quot;?&amp;gt;
&amp;lt;CORSConfiguration&amp;gt;
  &amp;lt;CORSRule&amp;gt;
    &amp;lt;AllowedOrigin&amp;gt;*kylebarron.dev&amp;lt;/AllowedOrigin&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;GET&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;HEAD&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;MaxAgeSeconds&amp;gt;3000&amp;lt;/MaxAgeSeconds&amp;gt;
    &amp;lt;AllowedHeader&amp;gt;*&amp;lt;/AllowedHeader&amp;gt;
  &amp;lt;/CORSRule&amp;gt;
  &amp;lt;CORSRule&amp;gt;
    &amp;lt;AllowedOrigin&amp;gt;http://www.example2.com&amp;lt;/AllowedOrigin&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;PUT&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;POST&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;AllowedMethod&amp;gt;DELETE&amp;lt;/AllowedMethod&amp;gt;
    &amp;lt;AllowedHeader&amp;gt;*&amp;lt;/AllowedHeader&amp;gt;
  &amp;lt;/CORSRule&amp;gt;
&amp;lt;/CORSConfiguration&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;update-cloudflares-cors-cache&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#update-cloudflares-cors-cache&quot; aria-label=&quot;update cloudflares cors cache permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;strong&gt;Update Cloudflare&amp;#x27;s CORS cache&lt;/strong&gt;&lt;/h3&gt;&lt;p&gt;If you&amp;#x27;ve updated your CORS,&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Serverless 3D Terrain]]></title><link>https://kylebarron.dev/blog/serverless-aerial-imagery</link><guid isPermaLink="false">https://kylebarron.dev/blog/serverless-aerial-imagery</guid><pubDate>Tue, 14 Apr 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;TODO: pricing section. Graph of costs per request usage. Mapbox free until 750,000 requests. &lt;a href=&quot;https://www.mapbox.com/pricing/#tile&quot;&gt;https://www.mapbox.com/pricing/#tile&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Serving aerial imagery map tiles on the fly with AWS Lambda and Cloud-Optimized
GeoTIFF.&lt;/p&gt;&lt;h2 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;h3 id=&quot;motivation&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#motivation&quot; aria-label=&quot;motivation permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Motivation&lt;/h3&gt;&lt;p&gt;Aerial imagery is huge, and generating and storing map tiles is non-trivial.&lt;/p&gt;&lt;p&gt;For a rough bounding box of the U.S. we can use &lt;a href=&quot;https://github.com/mapbox/mercantile&quot;&gt;&lt;code&gt;mercantile&lt;/code&gt;&lt;/a&gt; to
count the number of tiles at a mid-zoom.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; echo &amp;quot;[-126.71,24.49,-66.59,49.48]&amp;quot; | mercantile tiles 10 | wc -l
15824
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That&amp;#x27;s 15,000 tiles at &lt;em&gt;zoom 10&lt;/em&gt;. At each additional zoom each tile is split
into 4. So at zoom 16, which displays the NAIP tiles in full resolution (at
retina @2x resolution), the number of tiles is&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mn&gt;15&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;mo&gt;×&lt;/mo&gt;&lt;msup&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;16&lt;/mn&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mn&gt;10&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mo&gt;≈&lt;/mo&gt;&lt;mn&gt;65&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;15,000 \times 4^{16 - 10} \approx 65,000,000&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8388800000000001em;vertical-align:-0.19444em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;×&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8141079999999999em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.8141079999999999em;&quot;&gt;&lt;span style=&quot;top:-3.063em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;mbin mtight&quot;&gt;−&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mrel&quot;&gt;≈&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8388800000000001em;vertical-align:-0.19444em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;p&gt;That&amp;#x27;s &lt;em&gt;a lot&lt;/em&gt; of tiles. From &lt;a href=&quot;https://github.com/nst-guide/naip&quot;&gt;previous exploration&lt;/a&gt; of tiling
NAIP imagery, I found that each retina tile is around 500KB uncompressed or
100KB when compressed with &lt;code&gt;pngquant&lt;/code&gt;. Thus even compressed NAIP tiles for the
contiguous U.S. would take up 6.5 TB of space, and that&amp;#x27;s just for zoom 16. Zoom
15 would take another ~1.5 TB of space, and so on.&lt;/p&gt;&lt;h3 id=&quot;aws-open-data&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#aws-open-data&quot; aria-label=&quot;aws open data permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AWS Open Data&lt;/h3&gt;&lt;p&gt;NAIP data and Landsat images are hosted on AWS open datasets. The former is in
requester pays buckets; the latter is free for anyone to download. Crucially,
both are stored in Cloud-Optimized GeoTIFF (COG) format. This format uses HTTP
range requests to download a small portion of a larger COG file. This means it&amp;#x27;s
feasible to quickly work with portions of large images.&lt;/p&gt;&lt;h3 id=&quot;outline&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#outline&quot; aria-label=&quot;outline permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Outline&lt;/h3&gt;&lt;h2 id=&quot;high-zoom-serverless-naip&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#high-zoom-serverless-naip&quot; aria-label=&quot;high zoom serverless naip permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;High zoom: Serverless NAIP&lt;/h2&gt;&lt;p&gt;Install &lt;code&gt;cogeo-mosaic&lt;/code&gt;, which takes &lt;code&gt;.tif&lt;/code&gt; files as input and creates a
MosaicJSON. &lt;code&gt;cogeo-mosaic&lt;/code&gt; depends on &lt;code&gt;pygeos&lt;/code&gt;, which I&amp;#x27;ve been unable to
install through pip, so I first install that through Conda.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;conda install pygeos -c conda-forge -y
pip install cogeo-mosaic
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;First download the &lt;code&gt;manifest.txt&lt;/code&gt;. This file contains a listing of all files
stored in the &lt;code&gt;naip-visualization&lt;/code&gt; S3 bucket.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; aws s3 cp s3://naip-visualization/manifest.txt ./ --request-payer
&amp;gt; head -n 5 manifest.txt
al/2011/100cm/fgdc/30085/m_3008501_ne_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008501_nw_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008502_ne_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008502_nw_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008503_ne_16_1_20110815.txt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Aerial imagery is recorded by state, and most states have &lt;a href=&quot;https://www.arcgis.com/home/webmap/viewer.html?webmap=17944d45bbef42afb05a5652d7c28aa5&quot;&gt;multiple years of
availability&lt;/a&gt;. For example, imagery was taken of Alabama in 2011, 2013, 2015, and
2017. If I create a MosaicJSON using all years; the on-the-fly computations
would be more difficult because more source imagery would have to be compared to
generate a tile. I only care about most-recent imagery, so I&amp;#x27;ll extract the tif
image URLs of the latest year for each state.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# Generate file with state abbrevations
cat manifest.txt \
    `# Extract text before first /, i.e. the state abbr` \
    | awk -F &amp;#x27;/&amp;#x27; &amp;#x27;{print $1}&amp;#x27; \
    `# Deduplicate` \
    | uniq \
    `# Remove an extraneous line` \
    | sed &amp;#x27;/manifest.test/d&amp;#x27; \
    `# Save to states.txt` \
    &amp;gt; states.txt

# For each state abbrevation, get the most recent year of images
# For example, `al/2017`
cat states.txt | while read state
do
    cat manifest.txt \
        `# Keep only images of this state` \
        | grep &amp;quot;^${state}/&amp;quot; \
        `# Extract year` \
        | awk -F &amp;#x27;/&amp;#x27; &amp;#x27;{print $2}&amp;#x27; \
        `# Deduplicate` \
        | uniq \
        `# Sort by year, descending` \
        | sort -nr \
        `# Keep most recent year` \
        | head -n 1 \
        `# Prepend with state, so that it&amp;#x27;s {state}/{year}` \
        | sed -e &amp;quot;s|^|${state}/|&amp;quot; \
        `# Save to states_latest.txt` \
        &amp;gt;&amp;gt; states_latest.txt
done

# For each latest state-year combination, keep URLs of applicable tif images
cat states_latest.txt | while read state_latest
do
    cat manifest.txt \
        | grep &amp;quot;^${state_latest}/&amp;quot; \
        | grep &amp;quot;.tif&amp;quot; \
        | sed -e &amp;#x27;s|^|s3://naip-visualization/|&amp;#x27; \
        &amp;gt;&amp;gt; tif_latest.txt
done
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;See how many tif images per state&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat states.txt | while read state
do
    # printf &amp;quot;State: $state &amp;quot;
    cat tif_latest.txt \
        | grep &amp;quot;^s3://naip-visualization/${state}/&amp;quot; \
        | wc -l
done
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Example with Rhode Island&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat tif_latest.txt \
    | grep &amp;quot;^s3://naip-visualization/ri/&amp;quot; \
    | cogeo-mosaic footprint - &amp;gt; footprint.geojson
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Total number of files&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; wc -l tif_latest.txt
219068 tif_latest.txt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;NAIP imagery tiffs are in a requester pays bucket. In order to access them, you
need to set the &lt;code&gt;AWS_REQUEST_PAYER&lt;/code&gt; environment variable:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;export AWS_REQUEST_PAYER=&amp;quot;requester&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I also found that on an AWS EC2 instance; &lt;code&gt;cogeo-mosaic create&lt;/code&gt; was failing
while it was working on my local computer. In general, if &lt;code&gt;cogeo-mosaic create&lt;/code&gt;
isn&amp;#x27;t working for some URL; you should run &lt;code&gt;rio info &amp;lt;URL&amp;gt;&lt;/code&gt; and see what the
error is, since &lt;code&gt;cogeo-mosaic&lt;/code&gt; uses &lt;code&gt;rasterio&lt;/code&gt; internally, but doesn&amp;#x27;t currently
print &lt;code&gt;rasterio&lt;/code&gt; errors to stdout. In my case, I had to set the certificates
path (see
&lt;a href=&quot;https://github.com/cogeotiff/rio-tiler/issues/19&quot;&gt;cogeotiff/rio-tiler#19&lt;/a&gt;,
&lt;a href=&quot;https://github.com/mapbox/rasterio/issues/942&quot;&gt;mapbox/rasterio#942&lt;/a&gt;).&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then create the MosaicJSON file. GET requests are priced at &lt;code&gt;$0.0004&lt;/code&gt; per 1000
requests, so creating the MosaicJSON should cost &lt;code&gt;0.0004 * (219068 / 1000) =
0.087&lt;/code&gt;. 9 cents!&lt;/p&gt;&lt;p&gt;This took about 1.5GB of memory.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat tif_latest.txt \
    | cogeo-mosaic create - \
    &amp;gt; naip_mosaic.json
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;deploy&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#deploy&quot; aria-label=&quot;deploy permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deploy&lt;/h3&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/developmentseed/cogeo-mosaic-tiler.git

# Create lambda package
cd cogeo-mosaic-tiler &amp;amp; make package

# Deploy
npm install serverless -g
sls deploy --bucket kylebarron-landsat-test --region us-west-2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Add the mosaic json&lt;/p&gt;&lt;p&gt;Create Mosaic id (&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic-tiler/blob/master/doc/API.md#mosaicjson-path&quot;&gt;https://github.com/developmentseed/cogeo-mosaic-tiler/blob/master/doc/API.md#mosaicjson-path&lt;/a&gt;)&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;bucket_name=&amp;quot;...&amp;quot;
gzip -c naip_mosaic.json &amp;gt; naip_mosaic.json.gz
hash=$(sha224sum naip_mosaic.json.gz | awk &amp;#x27;{print $1}&amp;#x27;)
aws s3 cp naip_mosaic.json.gz &amp;quot;s3://${bucket_name}/mosaics/${hash}.json.gz&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;medium-zoom-serverless-landsat&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#medium-zoom-serverless-landsat&quot; aria-label=&quot;medium zoom serverless landsat permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Medium zoom: Serverless Landsat&lt;/h2&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/developmentseed/awspds-mosaic
cd awspds-mosaic
make package
cd services/landsat
sls deploy \
  --region us-west-2 \
  --bucket a-bucket-where-you-store-data \
  --token {OPTIONAL MAPBOX TOKEN}
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;low-zoom-pregenerated-landsat-tiles&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#low-zoom-pregenerated-landsat-tiles&quot; aria-label=&quot;low zoom pregenerated landsat tiles permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Low zoom: Pregenerated Landsat tiles&lt;/h2&gt;&lt;h2 id=&quot;caching-through-cloudflare&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#caching-through-cloudflare&quot; aria-label=&quot;caching through cloudflare permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Caching through Cloudflare&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/a/45849093&quot;&gt;This StackOverflow answer&lt;/a&gt; is a good overview of how
to connect Cloudflare as a proxy for API Gateway, so I won&amp;#x27;t go over the entire
process. Just a couple edits I made:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Since I&amp;#x27;m using the cheaper HTTP API Gateway endpoint instead of the standard REST API Gateway endpoint, the certificate needs to be uploaded to ACM in the same region as the lambda functions, which are in US-West-2 for NAIP.&lt;/li&gt;&lt;li&gt;I use the same base domain for traffic served directly from S3. Since S3 doesn&amp;#x27;t support HTTPS traffic, I need to have Cloudflare&amp;#x27;s SSL setting set to Flexible, which means that traffic is encrypted between the user and Cloudflare, but not between Cloudflare and S3. However I need to serve traffic to AWS API Gateway with HTTPS, so I set a page rule so that all traffic to AWS API Gateway has the Strict SSL setting. If you try to access your site and see a Cloudflare screen saying that the host server isn&amp;#x27;t responding, this may be your issue.&lt;/li&gt;&lt;li&gt;Don&amp;#x27;t forget to set a &amp;quot;Base Path Mapping&amp;quot; on the AWS API Gateway screen so that the traffic passed through the custom URL is correctly passed on to the right lambda function.&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;previous-work&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#previous-work&quot; aria-label=&quot;previous work permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Previous work&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/awslabs/landsat-on-aws&quot;&gt;&lt;code&gt;landsat-on-aws&lt;/code&gt;&lt;/a&gt; and the old &lt;a href=&quot;https://github.com/amazon-archives/naip-on-aws&quot;&gt;&lt;code&gt;naip-on-aws&lt;/code&gt;&lt;/a&gt; appear to have only served a single image at a time. The former is still running, and you can see the website at &lt;a href=&quot;https://landsatonaws.com/&quot;&gt;https://landsatonaws.com/&lt;/a&gt;.&lt;/p&gt;&lt;h2 id=&quot;references-and-more-info&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#references-and-more-info&quot; aria-label=&quot;references and more info permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;References and more info&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://medium.com/devseed/cog-talk-part-2-mosaics-bbbf474e66df&quot;&gt;Helpful blog post&lt;/a&gt; on mosaicing COGs, and introducing &lt;code&gt;rio-tiler-mosaic&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/mapbox/rio-glui&quot;&gt;&lt;code&gt;rio glui&lt;/code&gt;&lt;/a&gt;: inspect a COG in the browser on the fly. I see this as a raster equivalent of the great &lt;a href=&quot;https://github.com/mapbox/mbview&quot;&gt;&lt;code&gt;mbview&lt;/code&gt;&lt;/a&gt;, which lets you inspect vector tiles easily. &lt;code&gt;rio glui&lt;/code&gt; can only inspect one COG at a time, but still helpful.&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Serverless 3D Terrain]]></title><link>https://kylebarron.dev/blog/serverless-aerial-imagery</link><guid isPermaLink="false">https://kylebarron.dev/blog/serverless-aerial-imagery</guid><pubDate>Tue, 14 Apr 2020 22:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;TODO: pricing section. Graph of costs per request usage. Mapbox free until 750,000 requests. &lt;a href=&quot;https://www.mapbox.com/pricing/#tile&quot;&gt;https://www.mapbox.com/pricing/#tile&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Serving aerial imagery map tiles on the fly with AWS Lambda and Cloud-Optimized
GeoTIFF.&lt;/p&gt;&lt;h2 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;h3 id=&quot;motivation&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#motivation&quot; aria-label=&quot;motivation permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Motivation&lt;/h3&gt;&lt;p&gt;Aerial imagery is huge, and generating and storing map tiles is non-trivial.&lt;/p&gt;&lt;p&gt;For a rough bounding box of the U.S. we can use &lt;a href=&quot;https://github.com/mapbox/mercantile&quot;&gt;&lt;code&gt;mercantile&lt;/code&gt;&lt;/a&gt; to
count the number of tiles at a mid-zoom.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; echo &amp;quot;[-126.71,24.49,-66.59,49.48]&amp;quot; | mercantile tiles 10 | wc -l
15824
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;That&amp;#x27;s 15,000 tiles at &lt;em&gt;zoom 10&lt;/em&gt;. At each additional zoom each tile is split
into 4. So at zoom 16, which displays the NAIP tiles in full resolution (at
retina @2x resolution), the number of tiles is&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mn&gt;15&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;mo&gt;×&lt;/mo&gt;&lt;msup&gt;&lt;mn&gt;4&lt;/mn&gt;&lt;mrow&gt;&lt;mn&gt;16&lt;/mn&gt;&lt;mo&gt;−&lt;/mo&gt;&lt;mn&gt;10&lt;/mn&gt;&lt;/mrow&gt;&lt;/msup&gt;&lt;mo&gt;≈&lt;/mo&gt;&lt;mn&gt;65&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;mo separator=&quot;true&quot;&gt;,&lt;/mo&gt;&lt;mn&gt;000&lt;/mn&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;15,000 \times 4^{16 - 10} \approx 65,000,000&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8388800000000001em;vertical-align:-0.19444em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;×&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8141079999999999em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.8141079999999999em;&quot;&gt;&lt;span style=&quot;top:-3.063em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;mbin mtight&quot;&gt;−&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mtight&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mrel&quot;&gt;≈&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.8388800000000001em;vertical-align:-0.19444em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mpunct&quot;&gt;,&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;p&gt;That&amp;#x27;s &lt;em&gt;a lot&lt;/em&gt; of tiles. From &lt;a href=&quot;https://github.com/nst-guide/naip&quot;&gt;previous exploration&lt;/a&gt; of tiling
NAIP imagery, I found that each retina tile is around 500KB uncompressed or
100KB when compressed with &lt;code&gt;pngquant&lt;/code&gt;. Thus even compressed NAIP tiles for the
contiguous U.S. would take up 6.5 TB of space, and that&amp;#x27;s just for zoom 16. Zoom
15 would take another ~1.5 TB of space, and so on.&lt;/p&gt;&lt;h3 id=&quot;aws-open-data&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#aws-open-data&quot; aria-label=&quot;aws open data permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;AWS Open Data&lt;/h3&gt;&lt;p&gt;NAIP data and Landsat images are hosted on AWS open datasets. The former is in
requester pays buckets; the latter is free for anyone to download. Crucially,
both are stored in Cloud-Optimized GeoTIFF (COG) format. This format uses HTTP
range requests to download a small portion of a larger COG file. This means it&amp;#x27;s
feasible to quickly work with portions of large images.&lt;/p&gt;&lt;h3 id=&quot;outline&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#outline&quot; aria-label=&quot;outline permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Outline&lt;/h3&gt;&lt;h2 id=&quot;high-zoom-serverless-naip&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#high-zoom-serverless-naip&quot; aria-label=&quot;high zoom serverless naip permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;High zoom: Serverless NAIP&lt;/h2&gt;&lt;p&gt;Install &lt;code&gt;cogeo-mosaic&lt;/code&gt;, which takes &lt;code&gt;.tif&lt;/code&gt; files as input and creates a
MosaicJSON. &lt;code&gt;cogeo-mosaic&lt;/code&gt; depends on &lt;code&gt;pygeos&lt;/code&gt;, which I&amp;#x27;ve been unable to
install through pip, so I first install that through Conda.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;conda install pygeos -c conda-forge -y
pip install cogeo-mosaic
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;First download the &lt;code&gt;manifest.txt&lt;/code&gt;. This file contains a listing of all files
stored in the &lt;code&gt;naip-visualization&lt;/code&gt; S3 bucket.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; aws s3 cp s3://naip-visualization/manifest.txt ./ --request-payer
&amp;gt; head -n 5 manifest.txt
al/2011/100cm/fgdc/30085/m_3008501_ne_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008501_nw_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008502_ne_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008502_nw_16_1_20110815.txt
al/2011/100cm/fgdc/30085/m_3008503_ne_16_1_20110815.txt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Aerial imagery is recorded by state, and most states have &lt;a href=&quot;https://www.arcgis.com/home/webmap/viewer.html?webmap=17944d45bbef42afb05a5652d7c28aa5&quot;&gt;multiple years of
availability&lt;/a&gt;. For example, imagery was taken of Alabama in 2011, 2013, 2015, and
2017. If I create a MosaicJSON using all years; the on-the-fly computations
would be more difficult because more source imagery would have to be compared to
generate a tile. I only care about most-recent imagery, so I&amp;#x27;ll extract the tif
image URLs of the latest year for each state.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;# Generate file with state abbrevations
cat manifest.txt \
    `# Extract text before first /, i.e. the state abbr` \
    | awk -F &amp;#x27;/&amp;#x27; &amp;#x27;{print $1}&amp;#x27; \
    `# Deduplicate` \
    | uniq \
    `# Remove an extraneous line` \
    | sed &amp;#x27;/manifest.test/d&amp;#x27; \
    `# Save to states.txt` \
    &amp;gt; states.txt

# For each state abbrevation, get the most recent year of images
# For example, `al/2017`
cat states.txt | while read state
do
    cat manifest.txt \
        `# Keep only images of this state` \
        | grep &amp;quot;^${state}/&amp;quot; \
        `# Extract year` \
        | awk -F &amp;#x27;/&amp;#x27; &amp;#x27;{print $2}&amp;#x27; \
        `# Deduplicate` \
        | uniq \
        `# Sort by year, descending` \
        | sort -nr \
        `# Keep most recent year` \
        | head -n 1 \
        `# Prepend with state, so that it&amp;#x27;s {state}/{year}` \
        | sed -e &amp;quot;s|^|${state}/|&amp;quot; \
        `# Save to states_latest.txt` \
        &amp;gt;&amp;gt; states_latest.txt
done

# For each latest state-year combination, keep URLs of applicable tif images
cat states_latest.txt | while read state_latest
do
    cat manifest.txt \
        | grep &amp;quot;^${state_latest}/&amp;quot; \
        | grep &amp;quot;.tif&amp;quot; \
        | sed -e &amp;#x27;s|^|s3://naip-visualization/|&amp;#x27; \
        &amp;gt;&amp;gt; tif_latest.txt
done
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;See how many tif images per state&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat states.txt | while read state
do
    # printf &amp;quot;State: $state &amp;quot;
    cat tif_latest.txt \
        | grep &amp;quot;^s3://naip-visualization/${state}/&amp;quot; \
        | wc -l
done
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Example with Rhode Island&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat tif_latest.txt \
    | grep &amp;quot;^s3://naip-visualization/ri/&amp;quot; \
    | cogeo-mosaic footprint - &amp;gt; footprint.geojson
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Total number of files&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;&amp;gt; wc -l tif_latest.txt
219068 tif_latest.txt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;NAIP imagery tiffs are in a requester pays bucket. In order to access them, you
need to set the &lt;code&gt;AWS_REQUEST_PAYER&lt;/code&gt; environment variable:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;export AWS_REQUEST_PAYER=&amp;quot;requester&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I also found that on an AWS EC2 instance; &lt;code&gt;cogeo-mosaic create&lt;/code&gt; was failing
while it was working on my local computer. In general, if &lt;code&gt;cogeo-mosaic create&lt;/code&gt;
isn&amp;#x27;t working for some URL; you should run &lt;code&gt;rio info &amp;lt;URL&amp;gt;&lt;/code&gt; and see what the
error is, since &lt;code&gt;cogeo-mosaic&lt;/code&gt; uses &lt;code&gt;rasterio&lt;/code&gt; internally, but doesn&amp;#x27;t currently
print &lt;code&gt;rasterio&lt;/code&gt; errors to stdout. In my case, I had to set the certificates
path (see
&lt;a href=&quot;https://github.com/cogeotiff/rio-tiler/issues/19&quot;&gt;cogeotiff/rio-tiler#19&lt;/a&gt;,
&lt;a href=&quot;https://github.com/mapbox/rasterio/issues/942&quot;&gt;mapbox/rasterio#942&lt;/a&gt;).&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;export CURL_CA_BUNDLE=/etc/ssl/certs/ca-certificates.crt
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then create the MosaicJSON file. GET requests are priced at &lt;code&gt;$0.0004&lt;/code&gt; per 1000
requests, so creating the MosaicJSON should cost &lt;code&gt;0.0004 * (219068 / 1000) =
0.087&lt;/code&gt;. 9 cents!&lt;/p&gt;&lt;p&gt;This took about 1.5GB of memory.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;cat tif_latest.txt \
    | cogeo-mosaic create - \
    &amp;gt; naip_mosaic.json
&lt;/code&gt;&lt;/pre&gt;&lt;h3 id=&quot;deploy&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#deploy&quot; aria-label=&quot;deploy permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deploy&lt;/h3&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/developmentseed/cogeo-mosaic-tiler.git

# Create lambda package
cd cogeo-mosaic-tiler &amp;amp; make package

# Deploy
npm install serverless -g
sls deploy --bucket kylebarron-landsat-test --region us-west-2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Add the mosaic json&lt;/p&gt;&lt;p&gt;Create Mosaic id (&lt;a href=&quot;https://github.com/developmentseed/cogeo-mosaic-tiler/blob/master/doc/API.md#mosaicjson-path&quot;&gt;https://github.com/developmentseed/cogeo-mosaic-tiler/blob/master/doc/API.md#mosaicjson-path&lt;/a&gt;)&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;bucket_name=&amp;quot;...&amp;quot;
gzip -c naip_mosaic.json &amp;gt; naip_mosaic.json.gz
hash=$(sha224sum naip_mosaic.json.gz | awk &amp;#x27;{print $1}&amp;#x27;)
aws s3 cp naip_mosaic.json.gz &amp;quot;s3://${bucket_name}/mosaics/${hash}.json.gz&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;medium-zoom-serverless-landsat&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#medium-zoom-serverless-landsat&quot; aria-label=&quot;medium zoom serverless landsat permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Medium zoom: Serverless Landsat&lt;/h2&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/developmentseed/awspds-mosaic
cd awspds-mosaic
make package
cd services/landsat
sls deploy \
  --region us-west-2 \
  --bucket a-bucket-where-you-store-data \
  --token {OPTIONAL MAPBOX TOKEN}
&lt;/code&gt;&lt;/pre&gt;&lt;h2 id=&quot;low-zoom-pregenerated-landsat-tiles&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#low-zoom-pregenerated-landsat-tiles&quot; aria-label=&quot;low zoom pregenerated landsat tiles permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Low zoom: Pregenerated Landsat tiles&lt;/h2&gt;&lt;h2 id=&quot;caching-through-cloudflare&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#caching-through-cloudflare&quot; aria-label=&quot;caching through cloudflare permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Caching through Cloudflare&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://stackoverflow.com/a/45849093&quot;&gt;This StackOverflow answer&lt;/a&gt; is a good overview of how
to connect Cloudflare as a proxy for API Gateway, so I won&amp;#x27;t go over the entire
process. Just a couple edits I made:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Since I&amp;#x27;m using the cheaper HTTP API Gateway endpoint instead of the standard REST API Gateway endpoint, the certificate needs to be uploaded to ACM in the same region as the lambda functions, which are in US-West-2 for NAIP.&lt;/li&gt;&lt;li&gt;I use the same base domain for traffic served directly from S3. Since S3 doesn&amp;#x27;t support HTTPS traffic, I need to have Cloudflare&amp;#x27;s SSL setting set to Flexible, which means that traffic is encrypted between the user and Cloudflare, but not between Cloudflare and S3. However I need to serve traffic to AWS API Gateway with HTTPS, so I set a page rule so that all traffic to AWS API Gateway has the Strict SSL setting. If you try to access your site and see a Cloudflare screen saying that the host server isn&amp;#x27;t responding, this may be your issue.&lt;/li&gt;&lt;li&gt;Don&amp;#x27;t forget to set a &amp;quot;Base Path Mapping&amp;quot; on the AWS API Gateway screen so that the traffic passed through the custom URL is correctly passed on to the right lambda function.&lt;/li&gt;&lt;/ul&gt;&lt;h2 id=&quot;previous-work&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#previous-work&quot; aria-label=&quot;previous work permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Previous work&lt;/h2&gt;&lt;p&gt;&lt;a href=&quot;https://github.com/awslabs/landsat-on-aws&quot;&gt;&lt;code&gt;landsat-on-aws&lt;/code&gt;&lt;/a&gt; and the old &lt;a href=&quot;https://github.com/amazon-archives/naip-on-aws&quot;&gt;&lt;code&gt;naip-on-aws&lt;/code&gt;&lt;/a&gt; appear to have only served a single image at a time. The former is still running, and you can see the website at &lt;a href=&quot;https://landsatonaws.com/&quot;&gt;https://landsatonaws.com/&lt;/a&gt;.&lt;/p&gt;&lt;h2 id=&quot;references-and-more-info&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#references-and-more-info&quot; aria-label=&quot;references and more info permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;References and more info&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://medium.com/devseed/cog-talk-part-2-mosaics-bbbf474e66df&quot;&gt;Helpful blog post&lt;/a&gt; on mosaicing COGs, and introducing &lt;code&gt;rio-tiler-mosaic&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/mapbox/rio-glui&quot;&gt;&lt;code&gt;rio glui&lt;/code&gt;&lt;/a&gt;: inspect a COG in the browser on the fly. I see this as a raster equivalent of the great &lt;a href=&quot;https://github.com/mapbox/mbview&quot;&gt;&lt;code&gt;mbview&lt;/code&gt;&lt;/a&gt;, which lets you inspect vector tiles easily. &lt;code&gt;rio glui&lt;/code&gt; can only inspect one COG at a time, but still helpful.&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[All Transit]]></title><link>https://kylebarron.dev/blog/all-transit</link><guid isPermaLink="false">https://kylebarron.dev/blog/all-transit</guid><pubDate>Sun, 23 Feb 2020 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;&lt;a href=&quot;https://all-transit.com&quot;&gt;Interactive map&lt;/a&gt;&lt;/p&gt;&lt;p&gt;Transit connects the densest cities but is also surprisingly prevalent in some
remote Western states. I wanted to find and display all these routes. Once I&amp;#x27;d
done that for the U.S., why not the world? This project visualizes data from the
&lt;a href=&quot;https://transit.land&quot;&gt;Transitland&lt;/a&gt; project. The name alludes to &lt;a href=&quot;https://benfry.com/allstreets/map5.html&quot;&gt;&lt;em&gt;All
Streets&lt;/em&gt;&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://all-transit.com&quot;&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:51.25000000000001%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAEE/8QAFgEBAQEAAAAAAAAAAAAAAAAAAAID/9oADAMBAAIQAxAAAAHGNJKP/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQABBQJf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAFhAAAwAAAAAAAAAAAAAAAAAAAAEg/9oACAEBAAE/IZR//9oADAMBAAIAAwAAABDAz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABkQAAIDAQAAAAAAAAAAAAAAAAABEBFBMf/aAAgBAQABPxDJ0Qirh//Z&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;All transit in the continental U.S.&quot; title=&quot;All transit in the continental U.S.&quot; src=&quot;/static/aa7bc31644ee086460238e8758be9c07/18e3b/us.jpg&quot; srcSet=&quot;/static/aa7bc31644ee086460238e8758be9c07/46946/us.jpg 240w,/static/aa7bc31644ee086460238e8758be9c07/55489/us.jpg 480w,/static/aa7bc31644ee086460238e8758be9c07/18e3b/us.jpg 960w,/static/aa7bc31644ee086460238e8758be9c07/60e21/us.jpg 1440w,/static/aa7bc31644ee086460238e8758be9c07/69b48/us.jpg 1920w,/static/aa7bc31644ee086460238e8758be9c07/fac5f/us.jpg 7800w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;The schedule animation is my favorite part of the project. If you zoom into a
city (currently U.S. only) you can see streaks moving around that correspond to
transit vehicles: trains, buses, ferries. This data takes actual schedule
information from the Transitland API and matches it to route geometries.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://all-transit.com/#14.73/42.35435/-71.0638/31.8/46&quot;&gt;&lt;span class=&quot;gatsby-resp-image-wrapper&quot; style=&quot;position:relative;display:block;margin-left:auto;margin-right:auto;max-width:960px&quot;&gt;
      &lt;span class=&quot;gatsby-resp-image-background-image&quot; style=&quot;padding-bottom:83.33333333333334%;position:relative;bottom:0;left:0;background-image:url(&amp;#x27;data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAARCAYAAADdRIy+AAAACXBIWXMAABYlAAAWJQFJUiTwAAADZ0lEQVQ4y01U13biMBT0TyWQArjJcpHlBgESmm0wNWXPnv3+2ZHZh33QAWw0mnZlRfEKtljBj3eI8j2SfAdVNvD1GU72C7b+gZ92kNkeIr9hFO0xFBsMxBqP/goP3n09eh/9suz4AC+q8eqtMZI1Ir1DnG3wNl9gNt8SrEWUbSHzE0TWwSH4KG4xlA0GBBr+twYuAd2MTPSJTK54kQc8+w0mYYuQbHW1gco3iIoWXnqEq/Zwk5rs97BVh+dg14MY4AHZGeaWn39BFN9cP3DTC8YEc5IDJpTmqRO8/IhAN1wtjBo7Jsuk64GdpCGJGg/OO17CBuP4DMvRN/gE9PjppgTQFzjqQsAOdnTgQUfKPkKmO3jJjsyopj/wACda811DVSsSqXlICyvMLhCKG9MzPfqEn33RpxvGkfHr1HvnEMSw8lQDSbleduoBRLSg/CNeghrPDEnwuWXSlPTRABmWgrIFGQn6GpdHhPqAgCEIyo31FqFiaASVyQo6YzvIKkw3cOWcdmxheQzDM8zyT5jvIic4l60/EZU3Ah7hmCZQZsxwjPRIrVktA9RiPH4nIQbG2jnuzITywwQvXF0P5Jdf9PQLLg+QJUH5bBIzmMywJtv8woNaJn5ksg2GTyUmT0uMkjMeGU6fsmHoGS+LK4KCsotPuLTAZVjp4sQKXcho3zO9W3Nkdz/ImiRMWIOCw7HHmL8t14RBVk52xYSnmiCEYVGdkXKFRcceMmkmrIumb4IT75HmdV+roPqGlEvI0Udvk9Wz03d2Dj0c8ZRs1kEVNcbyXnKXZpt+ZgWrkjBhWpDkHYJkSwJXuAywEgvYQR/KuQec0IOovKCc3afB9MylxAnr4Sj+hwqkNhNz7kEE9+UcSQNuc38VvyF/0ARM7z1TxQnLxQEpvbKjpi+zrcha3RBPb5B8b5J2+dzLv+nlGfM5Lw29gR9QsjuHsNe8HCjBTw8oy5q+mMKSYbiGLXdM/Zse/UFQXtnJPWuyRZouUeoZSlWhiuZIoncG1OBVtP9mOSYb3jZjf0sPKC/c4TUgKA1OqisSAi2nU0yTDImcIYrfkRM4YDBmAILqN8LpldK7fp/1Nq2R5S2vL/rG28PmpeDTr6Q6oVAl5iqDVgse1PWTNKGfYX6FnpkR5ZRVvxByAAQvkKHzgb/wCJb6cM2dgAAAAABJRU5ErkJggg==&amp;#x27;);background-size:cover;display:block&quot;&gt;&lt;/span&gt;
  &lt;img class=&quot;gatsby-resp-image-image&quot; alt=&quot;Boston schedule animation&quot; title=&quot;Boston schedule animation&quot; src=&quot;/static/cd25a6d1907a389fdf9c9e9c6989e175/7d769/boston_schedule_animation.png&quot; srcSet=&quot;/static/cd25a6d1907a389fdf9c9e9c6989e175/5243c/boston_schedule_animation.png 240w,/static/cd25a6d1907a389fdf9c9e9c6989e175/ab158/boston_schedule_animation.png 480w,/static/cd25a6d1907a389fdf9c9e9c6989e175/7d769/boston_schedule_animation.png 960w,/static/cd25a6d1907a389fdf9c9e9c6989e175/87339/boston_schedule_animation.png 1440w,/static/cd25a6d1907a389fdf9c9e9c6989e175/88b03/boston_schedule_animation.png 1920w,/static/cd25a6d1907a389fdf9c9e9c6989e175/d43d8/boston_schedule_animation.png 1954w&quot; sizes=&quot;(max-width: 960px) 100vw, 960px&quot; style=&quot;width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0&quot; loading=&quot;lazy&quot;/&gt;
    &lt;/span&gt;&lt;/a&gt;&lt;/p&gt;&lt;p&gt;This rest of this blog post gives an overview of how the map is made.&lt;/p&gt;&lt;h3 id=&quot;transitland&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#transitland&quot; aria-label=&quot;transitland permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Transitland&lt;/h3&gt;&lt;p&gt;I use the &lt;a href=&quot;https://transit.land&quot;&gt;Transitland&lt;/a&gt; project as my data source, which
compiles &lt;a href=&quot;https://gtfs.org/&quot;&gt;GTFS feeds&lt;/a&gt; from around the world, and harmonizes
the data into a single dataset. You can read more about why that&amp;#x27;s important
&lt;a href=&quot;https://transit.land/documentation/onestop-id-scheme/&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Transitland serves &lt;em&gt;static&lt;/em&gt; transit information; it does not currently support
GTFS real time feeds (&lt;a href=&quot;https://github.com/transitland/transitland/issues/77&quot;&gt;but could in the
future&lt;/a&gt;). Their data model
is split into five components: &lt;em&gt;Operators&lt;/em&gt;, &lt;em&gt;Routes&lt;/em&gt;, &lt;em&gt;RouteStopPatterns&lt;/em&gt;,
&lt;em&gt;Stops&lt;/em&gt;, and &lt;em&gt;ScheduleStopPatterns&lt;/em&gt;.&lt;/p&gt;&lt;p&gt;An &lt;em&gt;operator&lt;/em&gt; is a transit agency that offers services to the general public
along fixed routes. A &lt;em&gt;route&lt;/em&gt; contains all information about a single transit
service as defined by the transit agency. A route can be a bit of a nebulous
topic, since often a single name has several branches. A &lt;em&gt;RouteStopPattern&lt;/em&gt;
decomposes each route into a single linear geometry. A route can be defined by
one or many RouteStopPatterns. A &lt;em&gt;stop&lt;/em&gt; is each point along a route or
RouteStopPattern where passengers may get on or off. A &lt;em&gt;ScheduleStopPattern&lt;/em&gt;
contains schedule information for each individual edge of the route. So if a
route has 10 stops in a line, there will be 9 ScheduleStopPattern data points
for each transit service scheduled along that route.&lt;/p&gt;&lt;h3 id=&quot;download&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#download&quot; aria-label=&quot;download permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Download&lt;/h3&gt;&lt;p&gt;Currently, Transitland doesn&amp;#x27;t offer bulk downloads. In order to download all
the data I had to find the best way to find and store all the data through their
API endpoints, which they have for each of the five categories enumerated above.&lt;/p&gt;&lt;p&gt;Each of API endpoint allows for a geographic bounding box. At first, I tried to
just pass a bounding box of the entire United States to each endpoint and
download results a page at a time. Unsurprisingly, that method isn&amp;#x27;t successful
for the endpoints that have more data to return, like stops and schedules,
because each API request has a timeout of 120 seconds, and it takes a while to
find and return the unindexed one-millionth row in a database. &lt;sup id=&quot;fnref-1&quot;&gt;&lt;a href=&quot;#fn-1&quot; class=&quot;footnote-ref&quot;&gt;1&lt;/a&gt;&lt;/sup&gt;&lt;/p&gt;&lt;p&gt;  It might be possible to use the database indexes better by providing the
&lt;a href=&quot;https://github.com/transitland/transitland-datastore/issues/1254#issuecomment-424813471&quot;&gt;&lt;code&gt;min_id&lt;/code&gt; query
parameter&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Because of this, I found it best in general to split API queries into smaller
pieces, by using e.g. operator or route identifiers. I ended up downloading
routes, route stop patterns, and stops by operator and schedule data by route. I
wrote a &lt;a href=&quot;https://github.com/kylebarron/transitland_wrapper&quot;&gt;Python/CLI wrapper&lt;/a&gt; for accessing the Transitland
database, to help with providing geometries and paging through all results.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;N.B.&lt;/strong&gt; I currently am hosting bulk downloads of the data I collected for the
project. You can find appropriate links on the &lt;a href=&quot;https://all-transit.com/about&quot;&gt;About
page&lt;/a&gt; of the project.&lt;/p&gt;&lt;h3 id=&quot;data-analysis&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#data-analysis&quot; aria-label=&quot;data analysis permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Data Analysis&lt;/h3&gt;&lt;p&gt;Most of the data-generating code for this project is done in Bash,
&lt;a href=&quot;https://stedolan.github.io/jq/&quot;&gt;&lt;code&gt;jq&lt;/code&gt;&lt;/a&gt;, GNU Parallel, SQLite, and a couple
Python scripts. In general, data is kept in &lt;em&gt;newline-delimited JSON&lt;/em&gt; and
&lt;em&gt;newline-delimited GeoJSON&lt;/em&gt; for all intermediate steps to facilitate streaming
and keep memory use low. However, I found that the schedule data was large
enough to necessitate transitioning to SQLite.&lt;/p&gt;&lt;p&gt;Operator, route, and stop information is encoded into &lt;a href=&quot;https://docs.mapbox.com/vector-tiles/reference/&quot;&gt;Mapbox Vector Tiles&lt;/a&gt;
using &lt;a href=&quot;https://github.com/mapbox/tippecanoe&quot;&gt;Tippecanoe&lt;/a&gt;. I use &lt;code&gt;jq&lt;/code&gt; to reshape the source GeoJSON to keep
only necessary attributes of each Feature.&lt;/p&gt;&lt;h4 id=&quot;schedule-data&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#schedule-data&quot; aria-label=&quot;schedule data permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Schedule data&lt;/h4&gt;&lt;p&gt;Schedule data from Transitland doesn&amp;#x27;t have a geometric component. In order to
connect schedules to geometries, you need to match the schedule data to the
routes &lt;em&gt;and&lt;/em&gt; stops data.&lt;/p&gt;&lt;p&gt;If you match schedule data just to routes, you have no way of knowing where
along the route the two stops are, and if you match schedule data just to stops,
you have no knowledge of the geometry between those two points.&lt;/p&gt;&lt;p&gt;Since some schedule data is missing links to route stop patterns, I first tried
to use &lt;em&gt;just&lt;/em&gt; the routes data. For each schedule stop pair, I found the &lt;code&gt;Point&lt;/code&gt;
geometries of its start and end stops, found the nearest points on the route for
each of those stops, and retrieved the geometry between those two stops.&lt;/p&gt;&lt;p&gt;This can be problematic, however, because routes can have complex geometries.
For example, metro lines in Chicago might be represented geometrically as a
loop; starting in the suburbs, going downtown around The Loop, and back to the
suburbs. When I use this process to match the schedule stop pair to the route, I
sometimes match one stop to the first end of the route, and the other stop to
the other end of the route. This caused my program to think that the train went
to downtown Chicago and back in one minute, and the animation looked haywire
depicting a train moving through Chicago at 600 miles per hour.&lt;/p&gt;&lt;p&gt;Helpfully, most (though not all) schedule data is also linked to a route stop
pattern, and the schedule data also generally has linear referencing distances
along that route stop pattern. So for example, a schedule stop pair might say
that the origin stop is 100 (meters) along the route stop pattern&amp;#x27;s geometry and
that the destination stop is 900 (meters) along its geometry. This allows for a
much more accurate way of finding schedule geometries. I take the route stop
pattern, project it into a local coordinate system with units in meters (I use
the local &lt;a href=&quot;https://en.wikipedia.org/wiki/Universal_Transverse_Mercator_coordinate_system&quot;&gt;UTM zone&lt;/a&gt;), and then cut the route stop pattern&amp;#x27;s
&lt;code&gt;LineString&lt;/code&gt; geometry using those two distances using Shapely&amp;#x27;s &lt;a href=&quot;https://shapely.readthedocs.io/en/stable/manual.html#substring&quot;&gt;linear
referencing methods&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Once I have a geometry for that schedule, I linearly interpolate timestamps
along each coordinate between start and end. I export this data as GeoJSON
&lt;code&gt;Feature&lt;/code&gt;s, where each geometry is a &lt;code&gt;LineString&lt;/code&gt; with three-dimensional
coordinates: longitude, latitude, and time.&lt;/p&gt;&lt;h4 id=&quot;schedule-tiles&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#schedule-tiles&quot; aria-label=&quot;schedule tiles permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Schedule tiles&lt;/h4&gt;&lt;p&gt;Now that I have these three-dimensional geometries, I need to figure out the
best way to transport them to the client. Unfortunately, at this time Tippecanoe
&lt;a href=&quot;https://github.com/mapbox/tippecanoe/issues/714&quot;&gt;doesn&amp;#x27;t support three-dimensional coordinates&lt;/a&gt;. The
recommendation in that thread was to reformat to have individual points with
properties. That would make it harder to associate the points to lines, however.&lt;/p&gt;&lt;p&gt;I decided to go with a custom data format; essentially tiled, gzipped, minified,
JSON. Since I know that all features are &lt;code&gt;LineStrings&lt;/code&gt;, and since I have no
properties that I care about, I keep only the line&amp;#x27;s coordinates. The verbose
depiction of the data the client receives:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-json&quot; metastring=&quot;noLineNumbers&quot;&gt;[
    // First LineString
    [
        // Coordinate of LineString
        [
            0, 1, 2
        ],
        // Coordinate of LineString
        [
            1, 2, 3
        ]
    ],
    // Second LineString
    [
        []
        ...
    ]
]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;In order to make the data download manageable, I cut each JSON into xyz map
tiles, so that only data pertaining to the current viewport is loaded. For dense
cities with high frequency transit like Washington DC and New York City, some
tiles can still be quite large. I cut the schedule tiles into full resolution at
zoom 13, and then generate overview tiles for lower zooms that contain a
fraction of the features of their child tiles.&lt;/p&gt;&lt;h3 id=&quot;website&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#website&quot; aria-label=&quot;website permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Website&lt;/h3&gt;&lt;p&gt;All portions of the website are self-hosted. The website itself is static and
hosted on Github Pages. The map tiles come from &lt;a href=&quot;https://openmaptiles.org/&quot;&gt;OpenMapTiles&lt;/a&gt; and
are served with &lt;a href=&quot;https://github.com/consbio/mbtileserver&quot;&gt;&lt;code&gt;mbtileserver&lt;/code&gt;&lt;/a&gt; on a Google Cloud f1-micro
instance. I have map tiles set to cache through Cloudflare to hopefully cope
fine with any spikes in demand. Vector tiles with operator, route, and stop
information are also hosted on the Google Cloud instance. The JSON tiles I use
for the schedule animation are currently hosted on AWS S3.&lt;/p&gt;&lt;p&gt;The website is coded with React and JavaScript, using Gatsby as the static site
generator. I use React Map GL/Mapbox GL JS for rendering the basemap and the
routes layer. I use Deck.gl&amp;#x27;s &lt;a href=&quot;https://deck.gl/#/documentation/deckgl-api-reference/layers/trips-layer&quot;&gt;&lt;code&gt;TripsLayer&lt;/code&gt;&lt;/a&gt; on top for rendering
the schedule animation.&lt;/p&gt;&lt;h3 id=&quot;performance&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#performance&quot; aria-label=&quot;performance permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Performance&lt;/h3&gt;&lt;p&gt;Although performance still isn&amp;#x27;t as good as I&amp;#x27;d like on lower-powered and mobile
devices, it&amp;#x27;s better than where I started.&lt;/p&gt;&lt;h4 id=&quot;minimize-data-downloads&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#minimize-data-downloads&quot; aria-label=&quot;minimize data downloads permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Minimize data downloads&lt;/h4&gt;&lt;p&gt;The source data for routes and especially for schedule information is huge. In
order to serve this data over a web map, they need to be compressed and sliced
into smaller pieces to download. This is why &lt;a href=&quot;https://en.wikipedia.org/wiki/Tiled_web_map&quot;&gt;map tiling&lt;/a&gt; exists.&lt;/p&gt;&lt;p&gt;I use &lt;a href=&quot;https://docs.mapbox.com/vector-tiles/reference/&quot;&gt;Mapbox Vector Tiles&lt;/a&gt; for transmitting operator, route, and stop data
to the client. Vector tiles are great because they&amp;#x27;re highly compressible, and
really easy to create with &lt;a href=&quot;https://github.com/mapbox/tippecanoe&quot;&gt;Tippecanoe&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;In order to keep the size of the vector tiles small, the &lt;code&gt;stops&lt;/code&gt; layer is
omitted until zoom 11, and the &lt;code&gt;routes&lt;/code&gt; layer omits metadata about the stops on
each route until zoom 11. (The maximum zoom level of data in the vector tiles is
11, but the data will display past zoom 11 thanks to overzooming.)&lt;/p&gt;&lt;p&gt;&lt;em&gt;Unfortunately&lt;/em&gt;, Tippecanoe only supports 2D data at this time. This means that
I had to develop my own solution for getting the schedule data to the client,
because I need a third dimension on those geometries (longitude, latitude,
time). For the time being I&amp;#x27;ve settled on tiled, gzipped, minified, JSON. Since
I know that all schedule data are &lt;code&gt;LineString&lt;/code&gt;s, I keep only the geometry part
of the GeoJSON, and don&amp;#x27;t transmit any properties data about each &lt;code&gt;Feature&lt;/code&gt; to
the client.&lt;/p&gt;&lt;p&gt;Since I couldn&amp;#x27;t use Tippecanoe for generating these JSON tiles, I developed my
own workflow for cutting GeoJSON features into tiles. I chose a reasonably high
zoom level, 13, which contains all schedule data in the selected time period in
full resolution. For lower zooms, I take a random fraction of a tile&amp;#x27;s children
tiles to keep tile sizes reasonable.&lt;/p&gt;&lt;h4 id=&quot;minimize-data-updates&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#minimize-data-updates&quot; aria-label=&quot;minimize data updates permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Minimize data updates&lt;/h4&gt;&lt;p&gt;I render invisble operator service area polygons so that I can easily find the
operators whose service area is in the viewbox. However I&amp;#x27;ve found that
constantly updating the list of nearby operators when panning can impact
performance, so instead I only compute that list when the operators option panel
is open.&lt;/p&gt;&lt;p&gt;I also turn off the schedule animation when the current zoom is below the
minimum zoom at which I show the animation. I&amp;#x27;m not sure how much this helps
performance because the Deck.gl &lt;code&gt;TileLayer&lt;/code&gt; already is invisble below that zoom
threshold, but it can&amp;#x27;t hurt.&lt;/p&gt;&lt;h4 id=&quot;deckgl-optimizations&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#deckgl-optimizations&quot; aria-label=&quot;deckgl optimizations permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deck.gl optimizations&lt;/h4&gt;&lt;p&gt;Deck.gl has a &lt;a href=&quot;https://deck.gl/#/documentation/developer-guide/performance-optimization&quot;&gt;page in its documentation&lt;/a&gt; detailing
strategies for improving performance.&lt;/p&gt;&lt;p&gt;I set &lt;code&gt;useDevicePixels&lt;/code&gt; to &lt;code&gt;false&lt;/code&gt;. When &lt;code&gt;true&lt;/code&gt;, this prop tells Deck.gl to
render at double the resolution on a high DPI display, which means that it must
do 4x the pixel computations. When the animation is more important than the
crispness of the map rendering, set this to &lt;code&gt;false&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;I also attempted to use precomputed binary attributes but hit some errors and
decided it wasn&amp;#x27;t worth it to debug right now. In the future I&amp;#x27;d like to figure
out how to use binary data directly.&lt;/p&gt;&lt;div class=&quot;footnotes&quot;&gt;&lt;hr/&gt;&lt;ol&gt;&lt;li id=&quot;fn-1&quot;&gt;&lt;a href=&quot;#fnref-1&quot; class=&quot;footnote-backref&quot;&gt;↩&lt;/a&gt;&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;</content:encoded></item><item><title><![CDATA[New Website]]></title><link>https://kylebarron.dev/blog/new-website</link><guid isPermaLink="false">https://kylebarron.dev/blog/new-website</guid><pubDate>Sun, 16 Feb 2020 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;After a few years of having a semi-dead &lt;a href=&quot;https://jekyllrb.com/&quot;&gt;Jekyll&lt;/a&gt;-based website, I&amp;#x27;m happy to transition to a new website based on &lt;a href=&quot;https://www.gatsbyjs.org/&quot;&gt;GatsbyJS&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;I&amp;#x27;m excited for this switch because I can incorporate some cool new technologies
into the site. For example, &lt;a href=&quot;https://github.com/kylebarron/kylebarron.github.io/blob/source/content/posts/new-website/index.mdx&quot;&gt;this post&lt;/a&gt; is written in &lt;a href=&quot;https://mdxjs.com/&quot;&gt;&lt;em&gt;MDX&lt;/em&gt;&lt;/a&gt;,
which allows you to combine the simplicity of Markdown with the flexibility of
React.&lt;/p&gt;&lt;p&gt;For example, I can have editable code snippets that accept updates from the user, like this:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-js&quot; metastring=&quot;react-live&quot;&gt;const onClick = () =&amp;gt; {
  alert(&amp;quot;Change this text&amp;quot;);
};
render(&amp;lt;button onClick={onClick}&amp;gt;Click me!&amp;lt;/button&amp;gt;);
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Update &lt;code&gt;Change this text&lt;/code&gt;, click the button, and you can see the text you just
put in!&lt;/p&gt;&lt;p&gt;I&amp;#x27;m using &lt;a href=&quot;https://www.gatsbyjs.org/starters/lekoarts/gatsby-starter-minimal-blog/&quot;&gt;this starter&lt;/a&gt;, which helped to get everything set up.
The website is hosted on Github Pages, and builds and deploys automatically on
every new commit using Travis CI, so I can just write and commit! Everything is
open source at &lt;a href=&quot;https://github.com/kylebarron/kylebarron.github.io&quot;&gt;https://github.com/kylebarron/kylebarron.github.io&lt;/a&gt;.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Self-hosted Static Vector Maps]]></title><link>https://kylebarron.dev/blog/self-hosted-static-vector-maps</link><guid isPermaLink="false">https://kylebarron.dev/blog/self-hosted-static-vector-maps</guid><pubDate>Sun, 16 Feb 2020 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;I put each map onto its own block disk, so that I can expand use as needed.&lt;/p&gt;&lt;p&gt;Go to Google Cloud Compute console, choose your VM instance, click &amp;quot;Edit&amp;quot;, then under &amp;quot;Additional Disks&amp;quot;, click &amp;quot;Add new disk&amp;quot;.&lt;/p&gt;&lt;p&gt;The &lt;a href=&quot;https://openmaptiles.com/downloads/dataset/osm/&quot;&gt;planet Mbtiles file&lt;/a&gt; for use by an open-data project is 51GB, so I&amp;#x27;ll make a new disk of ~55GB.&lt;/p&gt;&lt;p&gt;Give the disk a nice descriptive name like &lt;code&gt;openmaptiles-planet-2017-07-03&lt;/code&gt;. I made the disk for 55GB. Click &amp;quot;Done&amp;quot;, and the disk will be provisioned.&lt;/p&gt;&lt;p&gt;Now the disk is connected to the VM, but you still need to format and mount it. SSH into your server.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&amp;gt; sudo lsblk
NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
loop0     7:0    0 91.2M  1 loop /snap/google-cloud-sdk/118
loop2     7:2    0 91.4M  1 loop /snap/core/8689
loop3     7:3    0 91.3M  1 loop /snap/core/8592
loop4     7:4    0 90.7M  1 loop /snap/google-cloud-sdk/117
sda       8:0    0   15G  0 disk
├─sda1    8:1    0 14.9G  0 part /
├─sda14   8:14   0    4M  0 part
└─sda15   8:15   0  106M  0 part /boot/efi
sdb       8:16   0  100G  0 disk /mnt/disks/mbtiles-disk
sdc       8:32   0   55G  0 disk
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I can see that the new disk is at &lt;code&gt;/dev/sdc&lt;/code&gt; (it&amp;#x27;s 55GB and currently
unmounted).&lt;/p&gt;&lt;p&gt;Then format the disk. Note that this deletes all data on the disk, so make sure
you have the right identifier! (I&amp;#x27;m leaving &lt;code&gt;DEVICE_ID&lt;/code&gt; here so that I don&amp;#x27;t
accidentally copy-paste this in the future and forget to change the device id!)&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo mkfs.ext4 -m 0 -E lazy_itable_init=0,lazy_journal_init=0,discard /dev/[DEVICE_ID]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then create a new directory for the mount point:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;sudo mkdir -p /mnt/disks/openmaptiles-planet
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then mount the disk to that directory:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;sudo mount -o discard,defaults /dev/sdc /mnt/disks/openmaptiles-planet
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then grant read/write permissions to all users:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;sudo chmod a+w /mnt/disks/openmaptiles-planet
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now this disk is formatted and mounted, but every time you restart you&amp;#x27;ll have
to redo this process. In order to have the disk be auto-mounted on every
restart, you need to add an entry for the disk into &lt;code&gt;/etc/fstab&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Find the UUID for the disk:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;sudo blkid /dev/sdc
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then add an entry of the following to &lt;code&gt;/etc/fstab/&lt;/code&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;UUID=[UUID_VALUE] /mnt/disks/[MNT_DIR] ext4 discard,defaults,nofail 0 2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;So in my case I&amp;#x27;d add:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;UUID=406c2dad-373e-41a8-97ab-4e11fc86fd46 /mnt/disks/openmaptiles-planet ext4 discard,defaults,nofail 0 2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now download the &lt;code&gt;planet.mbtiles&lt;/code&gt; to the disk! It&amp;#x27;s a big file, so it could take
~1 hour.&lt;/p&gt;&lt;h2 id=&quot;references&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#references&quot; aria-label=&quot;references permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;References&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://cloud.google.com/compute/docs/disks/add-persistent-disk&quot;&gt;Google cloud guide for adding a disk&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;</content:encoded></item><item><title><![CDATA[Using GNU Make with Stata projects]]></title><link>https://kylebarron.dev/using-gnu-make-with-stata-projects</link><guid isPermaLink="false">https://kylebarron.dev/using-gnu-make-with-stata-projects</guid><pubDate>Tue, 20 Mar 2018 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;I&amp;#x27;ve thought about this before too. I don&amp;#x27;t currently have any projects that are large enough to absolutely necessitate using a program like Make (currently I number my files to keep dependencies straight). However, in general I&amp;#x27;m of the opinion that I&amp;#x27;d rather incorporate a program like Make while my program is small, when it&amp;#x27;s easiest to add to the Makefile as I go along.&lt;/p&gt;&lt;p&gt;Mauricio created his own Make-like system in Python, but isn&amp;#x27;t developing it anymore, and I don&amp;#x27;t want to keep up development of my own version of this when great open-source, well-supported tools exist.&lt;/p&gt;&lt;p&gt;I agree that GNU Make can be confusing, but I think one of the main reasons why it&amp;#x27;s confusing is that most documentation using it is geared towards C or C++ projects, with very complicated dependency structures. The nice thing about Make is that it&amp;#x27;s language independent and just uses shell commands. As long as your projects take place on a Linux/Unix or Mac environment, Make will always work.&lt;/p&gt;&lt;p&gt;I just put together a basic example of make with shell commands in a Git repository. Check it out with&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;git clone https://github.com/kylebarron/make-test.git
cd make-test
make
make dependency1
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;It should output&lt;/p&gt;&lt;pre&gt;&lt;code&gt;&amp;gt; make
bash dep1.sh
this is dependency 1
bash dep2.sh
this is dependency 2
# make dependency1
# make dependency2
bash final.sh
This is final.sh
&amp;gt; make dependency1
bash dep1.sh
this is dependency 1
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Look inside the Makefile and you&amp;#x27;ll see how simple it is. The Makefile is literally just&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-makefile&quot;&gt;all: final

dependency1:
    bash dep1.sh

dependency2:
    bash dep2.sh

dependency3:
    bash dep3.sh

final: dependency1 dependency2
    bash final.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Typing just &lt;code&gt;make&lt;/code&gt; runs the first &amp;quot;target&amp;quot;, the &lt;code&gt;all&lt;/code&gt; step. Since &lt;code&gt;all&lt;/code&gt; says to run &lt;code&gt;final&lt;/code&gt;, Make searches for that
target explanation. The items after &lt;code&gt;final:&lt;/code&gt; list its dependencies.
Since it lists &lt;code&gt;dependency1&lt;/code&gt; and &lt;code&gt;dependency2&lt;/code&gt;, Make runs whatever is specified for each of those, then runs whatever is specified for &lt;code&gt;final&lt;/code&gt;.
Note that &lt;code&gt;dependency3&lt;/code&gt; is not run when &lt;code&gt;final&lt;/code&gt; is run, since it&amp;#x27;s not listed as a dependency.&lt;/p&gt;&lt;p&gt;You can also ask Make to run a specific target. So &lt;code&gt;make dependency1&lt;/code&gt; runs &lt;code&gt;dependency1&lt;/code&gt; and whatever dependencies it has.&lt;/p&gt;&lt;p&gt;Instead of listing dependencies after the colon, you could also list them as &lt;code&gt;make dependency&lt;/code&gt; inside the clause, like&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-makefile&quot;&gt;final:
    make dependency1
    make dependency2
    bash final.sh
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I think this is simple enough to be used for Stata jobs, where instead of &lt;code&gt;bash dep1.sh&lt;/code&gt;, you use &lt;code&gt;stata-mp -b do filename.do&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;&lt;strong&gt;Important: you must use tabs for indentation&lt;/strong&gt;. I use spaces instead of tabs for most programming, like Stata and Python, but Make will only work with tabs. I use Atom for everything, and it automatically switches to using tabs when I name a file &lt;code&gt;Makefile&lt;/code&gt;.&lt;/p&gt;&lt;p&gt;Here are a few GNU Make tutorials written with data science in mind; I particularly like the first one:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;http://zmjones.com/make/&quot;&gt;GNU Make for Reproducible Data Analysis&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;https://bost.ocks.org/mike/make/&quot;&gt;Why Use Make&lt;/a&gt;&lt;/li&gt;&lt;li&gt;&lt;a href=&quot;http://www.jonzelner.net/statistics/make/reproducibility/2016/06/01/makefiles/&quot;&gt;Makefiles for fun and profit&lt;/a&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;A popular modern alternative to Make is luigi, which is developed by Spotify and widely-used, but I think that&amp;#x27;s actually overkill for Stata jobs.&lt;/p&gt;&lt;p&gt;There are also some language-specific workflow programs like &lt;a href=&quot;https://github.com/ropensci/drake&quot;&gt;drake&lt;/a&gt; for R, but that&amp;#x27;s obviously less appealing to me, when you can &lt;a href=&quot;http://stat545.com/automation00_index.html&quot;&gt;use make with R&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;Make will do that automatically; i.e. rerun automatically if the source timestamp is newer than the output timestamp, if the &amp;quot;target&amp;quot; name is the name of the outputted file. So if you&amp;#x27;re putting a Stata job in the makefile, you could do something like the following&lt;/p&gt;&lt;p&gt;&lt;code&gt;helloworld.do&lt;/code&gt;:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot;&gt;di &amp;quot;hello world&amp;quot;
&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code class=&quot;language-makefile&quot;&gt;helloworld.log: helloworld.do
    stata-mp -b do helloworld.do
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then the first time you run &lt;code&gt;make&lt;/code&gt;, it will do &lt;code&gt;stata-mp -b do helloworld.do&lt;/code&gt;. The second time (if you haven&amp;#x27;t changed &lt;code&gt;helloworld.do&lt;/code&gt;) it will print&lt;/p&gt;&lt;pre&gt;&lt;code&gt;make: `helloworld.log&amp;#x27; is up to date.
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;and won&amp;#x27;t run it again.&lt;/p&gt;&lt;p&gt;Make does this specifically because the file &lt;code&gt;helloworld.do&lt;/code&gt; is listed as a dependency after the &lt;code&gt;:&lt;/code&gt; for the &lt;code&gt;helloworld.log&lt;/code&gt; target.&lt;/p&gt;&lt;p&gt;Kyle&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Reading Stata files with Python]]></title><link>https://kylebarron.dev/blog/reading-stata-files-with-python</link><guid isPermaLink="false">https://kylebarron.dev/blog/reading-stata-files-with-python</guid><pubDate>Sun, 07 Jan 2018 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;p&gt;Stata is fine for the small stuff, but Python is way better for anything
intensive. However, you&amp;#x27;ll often have data in Stata&amp;#x27;s &lt;code&gt;.dta&lt;/code&gt; format that you
need to read. This post will detail the nice features available in Python&amp;#x27;s
Stata import.&lt;/p&gt;&lt;p&gt;We&amp;#x27;ll use the 1978 Automobile Data that comes with Stata. First export this data into a file in your working directory:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-stata&quot;&gt;sysuse auto
save &amp;quot;auto.dta&amp;quot;, replace
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now open up Python. First import Pandas, the module in Python used to work with rectangular data frames.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;import pandas as pd
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The most straightforward way to import a Stata file is a single line:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;auto = pd.read_stata(&amp;#x27;auto.dta&amp;#x27;)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This is really simple, and is fine for small files, but with larger files, you often need to finesse your data import.
Imagine you have a 100GB Stata file. For most computers, that&amp;#x27;s too big to import into memory.&lt;/p&gt;&lt;p&gt;First we need to create an &lt;em&gt;iterator&lt;/em&gt;, which reads the metadata attached to the &lt;code&gt;.dta&lt;/code&gt; file, but importantly doesn&amp;#x27;t read the data itself yet.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr = pd.read_stata(&amp;#x27;auto.dta&amp;#x27;, iterator = True)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now it&amp;#x27;s possible to read in just a chunk of the data at a time.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;auto = itr.get_chunk(5)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;You can also easily loop over the data like so:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr = pd.read_stata(&amp;#x27;auto.dta&amp;#x27;, iterator = True, chunksize = 10)
for df in itr:
    # Program operating on 10 rows of the dataset at a time

&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Now without importing the file, we can get the data label, number of observations, number of variables, and the timestamp at which the data were last saved.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr.data_label
itr.nobs
itr.nvar
itr.time_stamp
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If we want to see the names and labels of the variables, we can use&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr.varlist
itr.variable_labels()
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Note that &lt;code&gt;itr.variable_labels()&lt;/code&gt; returns a dictionary where the keys of the dictionary are the variable names and the values of the dictionary are the variable labels. So we can access the labels with something like:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;labels = itr.variable_labels()
# Gets the label of `mpg`
labels[&amp;#x27;mpg&amp;#x27;]
# Gets all keys
labels.keys()
# Gets all values
labels.values()
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;If you&amp;#x27;re working with a large dataset that might run up against memory constraints, you might want to keep in mind exactly how much memory the imported data will take up.&lt;/p&gt;&lt;p&gt;You can get a list of the number of bytes each column takes up with the &lt;code&gt;col_sizes&lt;/code&gt; method:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr.col_sizes
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;So in &lt;code&gt;auto.dta&lt;/code&gt;, the first column takes up 18 bytes for each row, while the rest of the columns take up between 1 and 4 bytes.&lt;/p&gt;&lt;p&gt;Lets get a better idea of what data types these columns are.&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-python&quot;&gt;itr.dtyplist
itr.fmtlist
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;The former shows you the data types that will be used in Python upon import and the latter shows the display formats the data had used in Stata (see &lt;a href=&quot;https://www.stata.com/help.cgi?format&quot;&gt;&lt;code&gt;help format&lt;/code&gt;&lt;/a&gt;).&lt;/p&gt;&lt;p&gt;From &lt;code&gt;itr.dtyplist&lt;/code&gt;, we can see that the first column is a string of length 18, while the rest are types &lt;code&gt;numpy.int8&lt;/code&gt;, &lt;code&gt;numpy.int16&lt;/code&gt;, and &lt;code&gt;numpy.float32&lt;/code&gt;. These data types come from &lt;a href=&quot;http://www.numpy.org/&quot;&gt;Numpy&lt;/a&gt;, a scientific library that Pandas is based upon, and correspond to Stata&amp;#x27;s &lt;code&gt;byte&lt;/code&gt;, &lt;code&gt;int&lt;/code&gt;, and &lt;code&gt;float&lt;/code&gt;, respectively (see Stata&amp;#x27;s &lt;a href=&quot;https://www.stata.com/help.cgi?datatypes&quot;&gt;&lt;code&gt;help data types&lt;/code&gt;&lt;/a&gt;).&lt;/p&gt;&lt;p&gt;The size of the data in memory is almost exactly the number of rows times the sum of the number of bytes needed for each row. I.e. if the number of rows is&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;N&lt;/mi&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;N&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.68333em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.10903em;&quot;&gt;N&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;p&gt;and the number of bytes each column uses is&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;msub&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;B_{col}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.83333em;vertical-align:-0.15em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.33610799999999996em;&quot;&gt;&lt;span style=&quot;top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot; style=&quot;margin-right:0.01968em;&quot;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.15em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;p&gt;then the total memory use of the dataset is&lt;/p&gt;&lt;span&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;N&lt;/mi&gt;&lt;mo&gt;∗&lt;/mo&gt;&lt;msub&gt;&lt;mo&gt;∑&lt;/mo&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;msub&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mrow&gt;&lt;mi&gt;c&lt;/mi&gt;&lt;mi&gt;o&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;/mrow&gt;&lt;/msub&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;N * \sum_{col} B_{col}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.68333em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.10903em;&quot;&gt;N&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;∗&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:1.0497100000000001em;vertical-align:-0.29971000000000003em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mop&quot;&gt;&lt;span class=&quot;mop op-symbol small-op&quot; style=&quot;position:relative;top:-0.0000050000000000050004em;&quot;&gt;∑&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.1863979999999999em;&quot;&gt;&lt;span style=&quot;top:-2.40029em;margin-left:0em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot; style=&quot;margin-right:0.01968em;&quot;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.29971000000000003em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.16666666666666666em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;msupsub&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.33610799999999996em;&quot;&gt;&lt;span style=&quot;top:-2.5500000000000003em;margin-left:-0.05017em;margin-right:0.05em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:2.7em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;sizing reset-size6 size3 mtight&quot;&gt;&lt;span class=&quot;mord mtight&quot;&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot;&gt;o&lt;/span&gt;&lt;span class=&quot;mord mathdefault mtight&quot; style=&quot;margin-right:0.01968em;&quot;&gt;l&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.15em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;p&gt;This can be helpful with understanding how many rows of a file to import at once. Let&amp;#x27;s say you want to not use more than 1GB of memory at once. If you want to import all columns of &lt;code&gt;auto.dta&lt;/code&gt;, each row takes up &lt;code&gt;sum(itr.col_sizes)&lt;/code&gt; = 43 bytes. So the number of rows you can import at a time is&lt;/p&gt;&lt;div&gt;&lt;span class=&quot;katex-display&quot;&gt;&lt;span class=&quot;katex&quot;&gt;&lt;span class=&quot;katex-mathml&quot;&gt;&lt;math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mn&gt;1024&lt;/mn&gt;&lt;mi&gt;M&lt;/mi&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;mo&gt;∗&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mn&gt;1024&lt;/mn&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;M&lt;/mi&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mo&gt;∗&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mn&gt;1024&lt;/mn&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mi&gt;K&lt;/mi&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mo&gt;∗&lt;/mo&gt;&lt;mfrac&gt;&lt;mrow&gt;&lt;mn&gt;1&lt;/mn&gt;&lt;mtext&gt; row&lt;/mtext&gt;&lt;/mrow&gt;&lt;mrow&gt;&lt;mn&gt;43&lt;/mn&gt;&lt;mi&gt;B&lt;/mi&gt;&lt;/mrow&gt;&lt;/mfrac&gt;&lt;mo&gt;≈&lt;/mo&gt;&lt;mn&gt;25&lt;/mn&gt;&lt;mtext&gt; million rows&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&quot;application/x-tex&quot;&gt;1024 MB * \frac{1024 KB}{1 MB} * \frac{1024 B}{1 KB} * \frac{1 \text{ row}}{43 B} \approx 25 \text{ million rows}&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&quot;katex-html&quot; aria-hidden=&quot;true&quot;&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.68333em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.10903em;&quot;&gt;M&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;∗&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:2.04633em;vertical-align:-0.686em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mopen nulldelimiter&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mfrac&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:1.36033em;&quot;&gt;&lt;span style=&quot;top:-2.314em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.10903em;&quot;&gt;M&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.23em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;frac-line&quot; style=&quot;border-bottom-width:0.04em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.677em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.07153em;&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.686em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mclose nulldelimiter&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;∗&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:2.04633em;vertical-align:-0.686em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mopen nulldelimiter&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mfrac&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:1.36033em;&quot;&gt;&lt;span style=&quot;top:-2.314em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.07153em;&quot;&gt;K&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.23em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;frac-line&quot; style=&quot;border-bottom-width:0.04em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.677em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.686em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mclose nulldelimiter&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mbin&quot;&gt;∗&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2222222222222222em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:2.00744em;vertical-align:-0.686em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mopen nulldelimiter&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mfrac&quot;&gt;&lt;span class=&quot;vlist-t vlist-t2&quot;&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:1.32144em;&quot;&gt;&lt;span style=&quot;top:-2.314em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;mord mathdefault&quot; style=&quot;margin-right:0.05017em;&quot;&gt;B&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.23em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;frac-line&quot; style=&quot;border-bottom-width:0.04em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&quot;top:-3.677em;&quot;&gt;&lt;span class=&quot;pstrut&quot; style=&quot;height:3em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;&lt;span class=&quot;mord&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;mord text&quot;&gt;&lt;span class=&quot;mord&quot;&gt; row&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-s&quot;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;vlist-r&quot;&gt;&lt;span class=&quot;vlist&quot; style=&quot;height:0.686em;&quot;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mclose nulldelimiter&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mrel&quot;&gt;≈&lt;/span&gt;&lt;span class=&quot;mspace&quot; style=&quot;margin-right:0.2777777777777778em;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;base&quot;&gt;&lt;span class=&quot;strut&quot; style=&quot;height:0.69444em;vertical-align:0em;&quot;&gt;&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;mord&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;mord text&quot;&gt;&lt;span class=&quot;mord&quot;&gt; million rows&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;p&gt;Obviously with the &lt;code&gt;auto.dta&lt;/code&gt; dataset we don&amp;#x27;t need to add restrictions on rows or columns, but in datasets with columns -- especially those with many string columns -- you might not be able to read in your whole dataset at once.&lt;/p&gt;</content:encoded></item><item><title><![CDATA[Self hosted vector topographic maps with OpenMapTiles]]></title><link>https://kylebarron.dev/self-hosted-vector-topographic-maps-with-open-map-tiles</link><guid isPermaLink="false">https://kylebarron.dev/self-hosted-vector-topographic-maps-with-open-map-tiles</guid><pubDate>Sat, 31 Dec 2016 23:00:00 GMT</pubDate><content:encoded>&lt;style data-emotion-css=&quot;1hycliv&quot;&gt;body{--theme-ui-colors-transparent:var(--theme-ui-colors-transparent,transparent);--theme-ui-colors-black:var(--theme-ui-colors-black,#000);--theme-ui-colors-white:var(--theme-ui-colors-white,#fff);--theme-ui-colors-gray-0:var(--theme-ui-colors-gray-0,null);--theme-ui-colors-gray-1:var(--theme-ui-colors-gray-1,#f7fafc);--theme-ui-colors-gray-2:var(--theme-ui-colors-gray-2,#edf2f7);--theme-ui-colors-gray-3:var(--theme-ui-colors-gray-3,#e2e8f0);--theme-ui-colors-gray-4:var(--theme-ui-colors-gray-4,#cbd5e0);--theme-ui-colors-gray-5:var(--theme-ui-colors-gray-5,#a0aec0);--theme-ui-colors-gray-6:var(--theme-ui-colors-gray-6,#718096);--theme-ui-colors-gray-7:var(--theme-ui-colors-gray-7,#4a5568);--theme-ui-colors-gray-8:var(--theme-ui-colors-gray-8,#2d3748);--theme-ui-colors-gray-9:var(--theme-ui-colors-gray-9,#1a202c);--theme-ui-colors-red-0:var(--theme-ui-colors-red-0,null);--theme-ui-colors-red-1:var(--theme-ui-colors-red-1,#fff5f5);--theme-ui-colors-red-2:var(--theme-ui-colors-red-2,#fed7d7);--theme-ui-colors-red-3:var(--theme-ui-colors-red-3,#feb2b2);--theme-ui-colors-red-4:var(--theme-ui-colors-red-4,#fc8181);--theme-ui-colors-red-5:var(--theme-ui-colors-red-5,#f56565);--theme-ui-colors-red-6:var(--theme-ui-colors-red-6,#e53e3e);--theme-ui-colors-red-7:var(--theme-ui-colors-red-7,#c53030);--theme-ui-colors-red-8:var(--theme-ui-colors-red-8,#9b2c2c);--theme-ui-colors-red-9:var(--theme-ui-colors-red-9,#742a2a);--theme-ui-colors-orange-0:var(--theme-ui-colors-orange-0,null);--theme-ui-colors-orange-1:var(--theme-ui-colors-orange-1,#fffaf0);--theme-ui-colors-orange-2:var(--theme-ui-colors-orange-2,#feebc8);--theme-ui-colors-orange-3:var(--theme-ui-colors-orange-3,#fbd38d);--theme-ui-colors-orange-4:var(--theme-ui-colors-orange-4,#f6ad55);--theme-ui-colors-orange-5:var(--theme-ui-colors-orange-5,#ed8936);--theme-ui-colors-orange-6:var(--theme-ui-colors-orange-6,#dd6b20);--theme-ui-colors-orange-7:var(--theme-ui-colors-orange-7,#c05621);--theme-ui-colors-orange-8:var(--theme-ui-colors-orange-8,#9c4221);--theme-ui-colors-orange-9:var(--theme-ui-colors-orange-9,#7b341e);--theme-ui-colors-yellow-0:var(--theme-ui-colors-yellow-0,null);--theme-ui-colors-yellow-1:var(--theme-ui-colors-yellow-1,#fffff0);--theme-ui-colors-yellow-2:var(--theme-ui-colors-yellow-2,#fefcbf);--theme-ui-colors-yellow-3:var(--theme-ui-colors-yellow-3,#faf089);--theme-ui-colors-yellow-4:var(--theme-ui-colors-yellow-4,#f6e05e);--theme-ui-colors-yellow-5:var(--theme-ui-colors-yellow-5,#ecc94b);--theme-ui-colors-yellow-6:var(--theme-ui-colors-yellow-6,#d69e2e);--theme-ui-colors-yellow-7:var(--theme-ui-colors-yellow-7,#b7791f);--theme-ui-colors-yellow-8:var(--theme-ui-colors-yellow-8,#975a16);--theme-ui-colors-yellow-9:var(--theme-ui-colors-yellow-9,#744210);--theme-ui-colors-green-0:var(--theme-ui-colors-green-0,null);--theme-ui-colors-green-1:var(--theme-ui-colors-green-1,#f0fff4);--theme-ui-colors-green-2:var(--theme-ui-colors-green-2,#c6f6d5);--theme-ui-colors-green-3:var(--theme-ui-colors-green-3,#9ae6b4);--theme-ui-colors-green-4:var(--theme-ui-colors-green-4,#68d391);--theme-ui-colors-green-5:var(--theme-ui-colors-green-5,#48bb78);--theme-ui-colors-green-6:var(--theme-ui-colors-green-6,#38a169);--theme-ui-colors-green-7:var(--theme-ui-colors-green-7,#2f855a);--theme-ui-colors-green-8:var(--theme-ui-colors-green-8,#276749);--theme-ui-colors-green-9:var(--theme-ui-colors-green-9,#22543d);--theme-ui-colors-teal-0:var(--theme-ui-colors-teal-0,null);--theme-ui-colors-teal-1:var(--theme-ui-colors-teal-1,#e6fffa);--theme-ui-colors-teal-2:var(--theme-ui-colors-teal-2,#b2f5ea);--theme-ui-colors-teal-3:var(--theme-ui-colors-teal-3,#81e6d9);--theme-ui-colors-teal-4:var(--theme-ui-colors-teal-4,#4fd1c5);--theme-ui-colors-teal-5:var(--theme-ui-colors-teal-5,#38b2ac);--theme-ui-colors-teal-6:var(--theme-ui-colors-teal-6,#319795);--theme-ui-colors-teal-7:var(--theme-ui-colors-teal-7,#2c7a7b);--theme-ui-colors-teal-8:var(--theme-ui-colors-teal-8,#285e61);--theme-ui-colors-teal-9:var(--theme-ui-colors-teal-9,#234e52);--theme-ui-colors-blue-0:var(--theme-ui-colors-blue-0,null);--theme-ui-colors-blue-1:var(--theme-ui-colors-blue-1,#ebf8ff);--theme-ui-colors-blue-2:var(--theme-ui-colors-blue-2,#bee3f8);--theme-ui-colors-blue-3:var(--theme-ui-colors-blue-3,#90cdf4);--theme-ui-colors-blue-4:var(--theme-ui-colors-blue-4,#63b3ed);--theme-ui-colors-blue-5:var(--theme-ui-colors-blue-5,#4299e1);--theme-ui-colors-blue-6:var(--theme-ui-colors-blue-6,#3182ce);--theme-ui-colors-blue-7:var(--theme-ui-colors-blue-7,#2b6cb0);--theme-ui-colors-blue-8:var(--theme-ui-colors-blue-8,#2c5282);--theme-ui-colors-blue-9:var(--theme-ui-colors-blue-9,#2a4365);--theme-ui-colors-indigo-0:var(--theme-ui-colors-indigo-0,null);--theme-ui-colors-indigo-1:var(--theme-ui-colors-indigo-1,#ebf4ff);--theme-ui-colors-indigo-2:var(--theme-ui-colors-indigo-2,#c3dafe);--theme-ui-colors-indigo-3:var(--theme-ui-colors-indigo-3,#a3bffa);--theme-ui-colors-indigo-4:var(--theme-ui-colors-indigo-4,#7f9cf5);--theme-ui-colors-indigo-5:var(--theme-ui-colors-indigo-5,#667eea);--theme-ui-colors-indigo-6:var(--theme-ui-colors-indigo-6,#5a67d8);--theme-ui-colors-indigo-7:var(--theme-ui-colors-indigo-7,#4c51bf);--theme-ui-colors-indigo-8:var(--theme-ui-colors-indigo-8,#434190);--theme-ui-colors-indigo-9:var(--theme-ui-colors-indigo-9,#3c366b);--theme-ui-colors-purple-0:var(--theme-ui-colors-purple-0,null);--theme-ui-colors-purple-1:var(--theme-ui-colors-purple-1,#faf5ff);--theme-ui-colors-purple-2:var(--theme-ui-colors-purple-2,#e9d8fd);--theme-ui-colors-purple-3:var(--theme-ui-colors-purple-3,#d6bcfa);--theme-ui-colors-purple-4:var(--theme-ui-colors-purple-4,#b794f4);--theme-ui-colors-purple-5:var(--theme-ui-colors-purple-5,#9f7aea);--theme-ui-colors-purple-6:var(--theme-ui-colors-purple-6,#805ad5);--theme-ui-colors-purple-7:var(--theme-ui-colors-purple-7,#6b46c1);--theme-ui-colors-purple-8:var(--theme-ui-colors-purple-8,#553c9a);--theme-ui-colors-purple-9:var(--theme-ui-colors-purple-9,#44337a);--theme-ui-colors-pink-0:var(--theme-ui-colors-pink-0,null);--theme-ui-colors-pink-1:var(--theme-ui-colors-pink-1,#fff5f7);--theme-ui-colors-pink-2:var(--theme-ui-colors-pink-2,#fed7e2);--theme-ui-colors-pink-3:var(--theme-ui-colors-pink-3,#fbb6ce);--theme-ui-colors-pink-4:var(--theme-ui-colors-pink-4,#f687b3);--theme-ui-colors-pink-5:var(--theme-ui-colors-pink-5,#ed64a6);--theme-ui-colors-pink-6:var(--theme-ui-colors-pink-6,#d53f8c);--theme-ui-colors-pink-7:var(--theme-ui-colors-pink-7,#b83280);--theme-ui-colors-pink-8:var(--theme-ui-colors-pink-8,#97266d);--theme-ui-colors-pink-9:var(--theme-ui-colors-pink-9,#702459);--theme-ui-colors-grayDark:var(--theme-ui-colors-grayDark,#2d3748);--theme-ui-colors-text:var(--theme-ui-colors-text,#2d3748);--theme-ui-colors-background:var(--theme-ui-colors-background,#fff);--theme-ui-colors-primary:var(--theme-ui-colors-primary,#6b46c1);--theme-ui-colors-primaryHover:var(--theme-ui-colors-primaryHover,#2c5282);--theme-ui-colors-secondary:var(--theme-ui-colors-secondary,#5f6c80);--theme-ui-colors-muted:var(--theme-ui-colors-muted,#e2e8f0);--theme-ui-colors-success:var(--theme-ui-colors-success,#9ae6b4);--theme-ui-colors-info:var(--theme-ui-colors-info,#63b3ed);--theme-ui-colors-warning:var(--theme-ui-colors-warning,#faf089);--theme-ui-colors-danger:var(--theme-ui-colors-danger,#feb2b2);--theme-ui-colors-light:var(--theme-ui-colors-light,#f7fafc);--theme-ui-colors-dark:var(--theme-ui-colors-dark,#2d3748);--theme-ui-colors-textMuted:var(--theme-ui-colors-textMuted,#718096);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-toggleIcon,#2d3748);--theme-ui-colors-heading:var(--theme-ui-colors-heading,#000);--theme-ui-colors-divide:var(--theme-ui-colors-divide,#cbd5e0);color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:var(--theme-ui-colors-modes-dark-text,#cbd5e0);--theme-ui-colors-primary:var(--theme-ui-colors-modes-dark-primary,#9f7aea);--theme-ui-colors-secondary:var(--theme-ui-colors-modes-dark-secondary,#7f8ea3);--theme-ui-colors-toggleIcon:var(--theme-ui-colors-modes-dark-toggleIcon,#cbd5e0);--theme-ui-colors-background:var(--theme-ui-colors-modes-dark-background,#1A202C);--theme-ui-colors-heading:var(--theme-ui-colors-modes-dark-heading,#fff);--theme-ui-colors-divide:var(--theme-ui-colors-modes-dark-divide,#2d3748);--theme-ui-colors-muted:var(--theme-ui-colors-modes-dark-muted,#2d3748);}&lt;/style&gt;&lt;style data-emotion-css=&quot;tm2q0o&quot;&gt;*{box-sizing:border-box;}body{margin:0;font-family:&quot;IBM Plex Sans&quot;,-apple-system,BlinkMacSystemFont,&quot;Segoe UI&quot;,Roboto,&quot;Helvetica Neue&quot;,Arial,&quot;Noto Sans&quot;,sans-serif,&quot;Apple Color Emoji&quot;,&quot;Segoe UI Emoji&quot;,&quot;Segoe UI Symbol&quot;,&quot;Noto Color Emoji&quot;;line-height:1.625;font-weight:400;color:var(--theme-ui-colors-text,#2d3748);background-color:var(--theme-ui-colors-background,#fff);padding:0;box-sizing:border-box;text-rendering:optimizeLegibility;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;}&lt;/style&gt;&lt;h2 id=&quot;self-hosted-topographic-vector-maps-with-openmaptiles&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#self-hosted-topographic-vector-maps-with-openmaptiles&quot; aria-label=&quot;self hosted topographic vector maps with openmaptiles permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Self hosted topographic vector maps with OpenMapTiles&lt;/h2&gt;&lt;p&gt;There are two types of map tiles: raster and vector. Akin to PNG vs SVG images, vector map tiles usually have smaller file sizes and don&amp;#x27;t have pixelation as you zoom.&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://switch2osm.org/&quot;&gt;Switch2OSM&lt;/a&gt; has some helpful notes for using OSM data, but it only mentions raster tiles, and it doesn&amp;#x27;t mention hosting maps on a static host such as S3.&lt;/p&gt;&lt;p&gt;If you need constantly updated maps, S3 might not be for you, but for my use case, I&amp;#x27;m fine with updating the OSM map tiles a couple times a year.&lt;/p&gt;&lt;p&gt;Vector tile benefits:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;smaller file sizes&lt;/li&gt;&lt;li&gt;completely static backend; all rendering happens on the client&lt;/li&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;&lt;h3 id=&quot;overview&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#overview&quot; aria-label=&quot;overview permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Overview&lt;/h3&gt;&lt;p&gt;For this example, I&amp;#x27;ll only generate map tiles for the US state of New Hampshire,&lt;/p&gt;&lt;ol&gt;&lt;li&gt;Set up AWS S3 to serve map tiles. Note that it&amp;#x27;s ok if a domain name you want has already been taken as a bucket, because you could host the website itself somewhere else, and just host the map tiles on S3.&lt;/li&gt;&lt;li&gt;Generate map layers&lt;ul&gt;&lt;li&gt;Use OpenMapTiles to generate vector map tiles (TODO: how is the OpenMapTiles schema different from the Mapbox schema? Why can&amp;#x27;t they just be interchanged?)&lt;/li&gt;&lt;li&gt;Generate terrain-rgb compliant tiles for client-side hillshading&lt;/li&gt;&lt;li&gt;Generate contour lines from USGS contours&lt;/li&gt;&lt;/ul&gt;&lt;/li&gt;&lt;li&gt;Upload the map data to S3&lt;/li&gt;&lt;li&gt;Style your map&lt;/li&gt;&lt;li&gt;Put it on a web map with Mapbox GL JS&lt;/li&gt;&lt;/ol&gt;&lt;h3 id=&quot;openmaptiles&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#openmaptiles&quot; aria-label=&quot;openmaptiles permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;OpenMapTiles&lt;/h3&gt;&lt;p&gt;The [OpenMapTiles][openmaptiles] project provides ready-to-use scripts to create
map tiles for a geographic area. Hard to create global tiles, but for a portion
of the US, it works well on a 2019 8-core MacbookPro.&lt;/p&gt;&lt;p&gt;The project works by encoding OSM vector data into portions of the tiles. Since
the minute details of roads and trails are unnecessary when zoomed out, features
are simplified at low zooms, and some features aren&amp;#x27;t included until a specific
zoom is met.&lt;/p&gt;&lt;p&gt;I found that for a topographic map, OpenMapTiles doesn&amp;#x27;t include trails and
streams in the vector tiles at my desired zoom level, so I&amp;#x27;ve forked the project
and set streams to appear at zoom XX and trails to appear at zoom XX.&lt;/p&gt;&lt;p&gt;If you don&amp;#x27;t want these changes, just clone the &lt;code&gt;openmaptiles/openmaptiles&lt;/code&gt; repo instead.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;git clone https://github.com/nst-guide/openmaptiles
cd openmaptiles
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then download the docker images:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;docker-compose pull
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Edit &lt;code&gt;QUICKSTART_MAX_ZOOM&lt;/code&gt; in &lt;code&gt;.env&lt;/code&gt; to your desired highest zoom level. I&amp;#x27;ve
found that this is only correctly set when the extract is downloaded again from
Geofabrik. If the extract already exists, this doesn&amp;#x27;t appear to get set.&lt;/p&gt;&lt;p&gt;It&amp;#x27;s usually a good idea to set a small zoom at first to make sure that
everything is working, and only then increase the zoom to a higher level for
production. Zoom 14 or 15 is usually a good max level.&lt;/p&gt;&lt;p&gt;Then run &lt;code&gt;./quickstart.sh {region}&lt;/code&gt; for any given Geofabrik region. This
downloads the OSM extract from Geofabrik, imports the data into a Postgres
database, and then writes output to an Mbtiles file according to the
OpenMapTiles schema. For this example with New Hampshire, run:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;./quickstart.sh new-hampshire
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Notes when merging multiple Geofabrik regions:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;p&gt;any Mbtiles file in the &lt;code&gt;data/&lt;/code&gt; directory is removed each time &lt;code&gt;./quickstart.sh&lt;/code&gt; is run. So if you want to merge two states, you should do:&lt;/p&gt;&lt;p&gt;  (TODO I forget the name of the output mbtiles file)&lt;/p&gt;&lt;pre&gt;&lt;code&gt;./quickstart.sh new-hampshire
mv data/*.mbtiles ./
./quickstart.sh vermont
tile-join combined.mbtiles data/*.mbtiles *.mbtiles
&lt;/code&gt;&lt;/pre&gt;&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;[openmaptiles]&lt;/p&gt;&lt;h3 id=&quot;contours&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#contours&quot; aria-label=&quot;contours permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Contours&lt;/h3&gt;&lt;p&gt;Contour lines (isobands) are essential for a topographic map. They show equal
heights on the land. The US Geological Survey releases [1x1 degree 40&amp;#x27; contour
line data][contours] generated from their 1/3 arc-second seamless DEM. While
it&amp;#x27;s possible to generate contours yourself from a Digital Elevation Model,
using the USGS&amp;#x27;s contours are easy because they&amp;#x27;re already in vector format. In
order to integrate this data with OpenMapTiles, I need to cut the contour lines
into vector tiles, and then add them as a separate source in my &lt;code&gt;style.json&lt;/code&gt;
file.&lt;/p&gt;&lt;p&gt;I&amp;#x27;ve written scripts to query the USGS API and download contours for a given bounding box.&lt;/p&gt;&lt;pre&gt;&lt;code&gt;git clone https://github.com/nst-guide/contours
cd contours
pip install click requests
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This also has dependencies on GDAL and
&lt;a href=&quot;https://github.com/mapbox/tippecanoe&quot;&gt;&lt;code&gt;tippecanoe&lt;/code&gt;&lt;/a&gt;. I find that the easiest
way of installing GDAL and tippecanoe is through Conda:&lt;/p&gt;&lt;pre&gt;&lt;code&gt;conda create -n contours python gdal tippecanoe -c conda-forge
source activate contours
pip install click requests
&lt;/code&gt;&lt;/pre&gt;&lt;h4 id=&quot;download-files&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#download-files&quot; aria-label=&quot;download files permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Download files&lt;/h4&gt;&lt;p&gt;I generally use &lt;a href=&quot;https://boundingbox.klokantech.com/&quot;&gt;https://boundingbox.klokantech.com/&lt;/a&gt; to visually create
bounding boxes. This is a good one for New Hampshire:&lt;/p&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;python download.py --bbox=&amp;quot;-72.5623, 42.6938, -70.6603, 45.3534&amp;quot;
bash to_geojson.sh
tippecanoe \
    -Z11 \
    -zg \
    -P \
    --extend-zooms-if-still-dropping \
    -y FCode -y ContourElevation \
    -l Elev_Contour \
    -o contours.mbtiles \
    data/geojson/*.geojson
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I use these tippecanoe options:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;&lt;code&gt;-Z11&lt;/code&gt;: Set the minimum zoom to 11. Tippecanoe won&amp;#x27;t create any overview tiles.&lt;/li&gt;&lt;li&gt;&lt;code&gt;-zg&lt;/code&gt;: Let Tippecanoe guess the maximum zoom level. It seems from testing that it selects &lt;code&gt;11&lt;/code&gt;, i.e. that 11 is high enough to represent the contours&lt;/li&gt;&lt;li&gt;&lt;code&gt;-P&lt;/code&gt;: run in parallel. If the GeoJSON files are not line-delimited, won&amp;#x27;t actually run in parallel.&lt;/li&gt;&lt;li&gt;&lt;code&gt;--extend-zooms-if-still-dropping&lt;/code&gt;: Not sure if this actually does anything since I&amp;#x27;m not using &lt;code&gt;--drop-densest-as-needed&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;&lt;code&gt;-y&lt;/code&gt;: only keep the provided attributes in the MVT. I think the only metadata needed for styling is &lt;code&gt;FCode&lt;/code&gt;, which determines whether it&amp;#x27;s a multiple of 200&amp;#x27; and should be styled darker, and &lt;code&gt;ContourElevation&lt;/code&gt;, which stores the elevation itself. I haven&amp;#x27;t checked if you can do modular arithmetic on the fly in the Mapbox style specification, but if you can then you could leave out &lt;code&gt;FCode&lt;/code&gt;.&lt;/li&gt;&lt;li&gt;&lt;code&gt;-l&lt;/code&gt;: combine all files into a single layer named &lt;code&gt;Elev_Contour&lt;/code&gt;. Otherwise, it would create a different layer in the vector tiles for each provided file name&lt;/li&gt;&lt;li&gt;&lt;code&gt;-o&lt;/code&gt;: output file name. If you want a directory of vector tiles instead of a &lt;code&gt;.mbtiles&lt;/code&gt; file, use &lt;code&gt;-e&lt;/code&gt;&lt;/li&gt;&lt;li&gt;&lt;code&gt;data/geojson/*.geojson&lt;/code&gt;: path to input data&lt;/li&gt;&lt;/ul&gt;&lt;h3 id=&quot;hillshading&quot; style=&quot;position:relative&quot;&gt;&lt;a href=&quot;#hillshading&quot; aria-label=&quot;hillshading permalink&quot; class=&quot;anchor before&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Hillshading&lt;/h3&gt;&lt;p&gt;Hillshading is essential&lt;/p&gt;&lt;pre&gt;&lt;code&gt;git clone https://github.com/nst-guide/hillshade
cd hillshade
&lt;/code&gt;&lt;/pre&gt;&lt;pre&gt;&lt;code class=&quot;language-bash&quot;&gt;python download.py --bbox=&amp;quot;-72.5623, 42.6938, -70.6603, 45.3534&amp;quot; --high_res
bash unzip.sh --high_res
gdalbuildvrt -vrtnodata -9999 data/dem_hr_9999.vrt data/unzipped_hr/*.img
gdalwarp -r cubicspline -s_srs EPSG:4269 -t_srs EPSG:3857 -dstnodata 0 -co COMPRESS=DEFLATE data/dem_hr_9999.vrt data/dem_hr_9999_epsg3857.vrt
rio rgbify -b -10000 -i 0.1 --min-z 6 --max-z 13 -j 15 --format webp data/dem_hr_9999_epsg3857.vrt data/terrain_webp.mbtiles
rio rgbify -b -10000 -i 0.1 --min-z 6 --max-z 13 -j 15 --format png data/dem_hr_9999_epsg3857.vrt data/terrain_png.mbtiles
mb-util data/terrain_webp.mbtiles data/terrain_webp
mb-util data/terrain_png.mbtiles data/terrain_png
&lt;/code&gt;&lt;/pre&gt;</content:encoded></item></channel></rss>