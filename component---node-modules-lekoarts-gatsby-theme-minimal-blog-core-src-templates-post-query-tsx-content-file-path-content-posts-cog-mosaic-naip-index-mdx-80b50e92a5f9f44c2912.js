"use strict";(self.webpackChunkkylebarron_github_io=self.webpackChunkkylebarron_github_io||[]).push([[313],{4765:function(e,t,a){a.d(t,{F:function(){return d},Z:function(){return u}});var n=a(7294),i=a(7642),r=a(795),o=a(5040),l=a(6799),s=a(8871);var c=e=>{let{post:t}=e;return null};const m=["16px","8px","4px"].map((e=>"rgba(0, 0, 0, 0.1) 0px "+e+" "+e+" 0px"));var h=e=>{let{data:{post:t},children:a}=e;return(0,i.tZ)(o.Z,null,(0,i.tZ)(r.X6,{as:"h1",variant:"styles.h1"},t.title),(0,i.tZ)("p",{sx:{color:"secondary",mt:3,a:{color:"secondary"},fontSize:[1,1,2]}},(0,i.tZ)("time",null,t.date),t.tags&&(0,i.tZ)(n.Fragment,null," — ",(0,i.tZ)(l.Z,{tags:t.tags})),t.timeToRead&&" — ",t.timeToRead&&(0,i.tZ)("span",null,t.timeToRead," min read")),(0,i.tZ)("section",{sx:{my:5,".gatsby-resp-image-wrapper":{my:[4,4,5],borderRadius:"4px",boxShadow:m.join(", "),".gatsby-resp-image-image":{borderRadius:"4px"}},variant:"layout.content"}},a),(0,i.tZ)(c,{post:t}))};const d=e=>{var t,a,n;let{data:{post:r}}=e;return(0,i.tZ)(s.Z,{title:r.title,description:r.description?r.description:r.excerpt,image:r.banner?null===(t=r.banner)||void 0===t||null===(a=t.childImageSharp)||void 0===a||null===(n=a.resize)||void 0===n?void 0:n.src:void 0,pathname:r.slug,canonicalUrl:r.canonicalUrl})};function u(e){let{...t}=e;return n.createElement(h,t)}},6799:function(e,t,a){var n=a(7642),i=a(7294),r=a(4160),o=a(3494),l=a(9706);t.Z=e=>{let{tags:t}=e;const{tagsPath:a,basePath:s}=(0,o.Z)();return(0,n.tZ)(i.Fragment,null,t.map(((e,t)=>(0,n.tZ)(i.Fragment,{key:e.slug},!!t&&", ",(0,n.tZ)(r.rU,{sx:e=>{var t;return{...null===(t=e.styles)||void 0===t?void 0:t.a}},to:(0,l.Z)("/"+s+"/"+a+"/"+e.slug)},e.name)))))}},8871:function(e,t,a){var n=a(7294),i=a(4160),r=a(4232);t.Z=e=>{let{title:t="",description:a="",pathname:o="",image:l="",children:s=null,canonicalUrl:c=""}=e;const m=(0,r.Z)(),{siteTitle:h,siteTitleAlt:d,siteUrl:u,siteDescription:g,siteImage:p,author:f,siteLanguage:A}=m,v={title:t?t+" | "+h:d,description:a||g,url:""+u+(o||""),image:""+u+(l||p)};return n.createElement(n.Fragment,null,n.createElement("html",{lang:A}),n.createElement("title",null,v.title),n.createElement("meta",{name:"description",content:v.description}),n.createElement("meta",{name:"image",content:v.image}),n.createElement("meta",{property:"og:title",content:v.title}),n.createElement("meta",{property:"og:url",content:v.url}),n.createElement("meta",{property:"og:description",content:v.description}),n.createElement("meta",{property:"og:image",content:v.image}),n.createElement("meta",{property:"og:type",content:"website"}),n.createElement("meta",{property:"og:image:alt",content:v.description}),n.createElement("meta",{name:"twitter:card",content:"summary_large_image"}),n.createElement("meta",{name:"twitter:title",content:v.title}),n.createElement("meta",{name:"twitter:url",content:v.url}),n.createElement("meta",{name:"twitter:description",content:v.description}),n.createElement("meta",{name:"twitter:image",content:v.image}),n.createElement("meta",{name:"twitter:image:alt",content:v.description}),n.createElement("meta",{name:"twitter:creator",content:f}),n.createElement("meta",{name:"gatsby-theme",content:"@lekoarts/gatsby-theme-minimal-blog"}),n.createElement("link",{rel:"icon",type:"image/png",sizes:"32x32",href:(0,i.dq)("/favicon-32x32.png")}),n.createElement("link",{rel:"icon",type:"image/png",sizes:"16x16",href:(0,i.dq)("/favicon-16x16.png")}),n.createElement("link",{rel:"apple-touch-icon",sizes:"180x180",href:(0,i.dq)("/apple-touch-icon.png")}),c?n.createElement("link",{rel:"canonical",href:c}):null,s)}},8567:function(e,t,a){a.r(t),a.d(t,{Head:function(){return l.F},default:function(){return s}});var n=a(7294),i=a(1151);function r(e){const t=Object.assign({a:"a",span:"span",p:"p",strong:"strong",h2:"h2",ul:"ul",li:"li",blockquote:"blockquote",code:"code",em:"em",h3:"h3",ol:"ol"},(0,i.ah)(),e.components);return n.createElement(n.Fragment,null,n.createElement(t.a,{href:"http://kylebarron.github.io/naip-cogeo-mosaic/"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<span\n      class="gatsby-resp-image-wrapper"\n      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 960px; "\n    >\n      <span\n    class="gatsby-resp-image-background-image"\n    style="padding-bottom: 54.58333333333334%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAIDAQT/xAAVAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAABWPRGL0UT/8QAGhAAAQUBAAAAAAAAAAAAAAAAAAECEBExMv/aAAgBAQABBQJcKHcx/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGxAAAwACAwAAAAAAAAAAAAAAAAERITFBYcH/2gAIAQEAAT8hWZDidlF0No/DhH//2gAMAwEAAgADAAAAEIgP/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/ELWv/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8QJ//EABoQAQADAQEBAAAAAAAAAAAAAAEAETEhYZH/2gAIAQEAAT8QQFa89hCMnt2ECrE3rc+KYOGnIqrfUn//2Q==\'); background-size: cover; display: block;"\n  ></span>\n  <img\n        class="gatsby-resp-image-image"\n        alt="60cm-resolution NAIP imagery of the Grand Canyon from 2017"\n        title=""\n        src="/static/da6e407cc9e40feacc0aafa2ddab473d/18e3b/grca.jpg"\n        srcset="/static/da6e407cc9e40feacc0aafa2ddab473d/46946/grca.jpg 240w,\n/static/da6e407cc9e40feacc0aafa2ddab473d/55489/grca.jpg 480w,\n/static/da6e407cc9e40feacc0aafa2ddab473d/18e3b/grca.jpg 960w,\n/static/da6e407cc9e40feacc0aafa2ddab473d/60e21/grca.jpg 1440w,\n/static/da6e407cc9e40feacc0aafa2ddab473d/ae03e/grca.jpg 1767w"\n        sizes="(max-width: 960px) 100vw, 960px"\n        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"\n        loading="lazy"\n        decoding="async"\n      />\n    </span>'}})),"\n",n.createElement(t.p,null,"60cm-resolution imagery of the Grand Canyon from 2017. ",n.createElement(t.strong,null,n.createElement(t.a,{href:"http://kylebarron.github.io/naip-cogeo-mosaic/"},"Click for an\ninteractive example")),"."),"\n",n.createElement(t.h2,{id:"overview",style:{position:"relative"}},n.createElement(t.a,{href:"#overview","aria-label":"overview permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Overview"),"\n",n.createElement(t.p,null,"More and more public imagery sources are being provided in ",n.createElement(t.a,{href:"https://www.cogeo.org/"},"Cloud-Optimized\nGeoTIFF (COG)"),", an efficient file format for fast random-access reads\nof geospatial raster data. This is revolutionary because the format enables new\ncloud-native workflows, such as serving imagery to a web map on demand, that\nwere never before possible."),"\n",n.createElement(t.p,null,"Within half a second, a server can grab and combine the relevant portions of\nhalf a dozen images, reproject into the coordinate reference system used in web\nmapping, and return it to the user. Making this process happen on demand can\nlead to huge reductions in cost—and zero fixed cost—as terabytes of map data no\nlonger need to be stored pregenerated and stored."),"\n",n.createElement(t.p,null,"This post builds upon a ",n.createElement(t.a,{href:"https://kylebarron.dev/blog/cog-mosaic/overview"},"previous overview post")," to give more\nconcrete details on working with the ",n.createElement(t.a,{href:"https://registry.opendata.aws/naip/"},"public NAIP collection on AWS\nS3"),", a repository of cloudless aerial imagery spanning the lower 48\nU.S. states at up to 60-centimeter resolution. In the following sections I'll\ngive an overview of the imagery available and best practices for optimal\nperformance. For deployment instructions and other documentation, ",n.createElement(t.a,{href:"https://github.com/kylebarron/naip-cogeo-mosaic"},"visit the\nproject on Github"),"."),"\n",n.createElement(t.h2,{id:"naip-data",style:{position:"relative"}},n.createElement(t.a,{href:"#naip-data","aria-label":"naip data permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"NAIP Data"),"\n",n.createElement(t.p,null,"The U.S. Department of Agriculture (USDA) oversees the ",n.createElement(t.a,{href:"https://www.fsa.usda.gov/programs-and-services/aerial-photography/imagery-programs/naip-imagery/"},"National Agriculture\nImagery Program (NAIP)"),". Since 2003, this program has collected\nhigh-resolution aerial imagery of the continental U.S., with recent years\nphotographed at 60-centimeter resolution. This data has been free to use for a\nwhile, but historically has been locked in cloud-unfriendly,\n",n.createElement(t.a,{href:"https://en.wikipedia.org/wiki/MrSID"},"closed-source")," formats."),"\n",n.createElement(t.p,null,"However, thanks to the AWS Open Data program, NAIP imagery from 2011 to 2018 is\navailable on a ",n.createElement(t.a,{href:"https://registry.opendata.aws/naip/"},"public S3 bucket")," in ",n.createElement(t.a,{href:"https://www.cogeo.org/"},"Cloud-Optimized GeoTIFF\n(COG)")," format. As I explained in a ",n.createElement(t.a,{href:"https://kylebarron.dev/blog/cog-mosaic/overview"},"previous blog post"),",\nCOGs democratize access to large collections of raster data by enabling fast\nrandom-access reads."),"\n",n.createElement(t.p,null,"Given this large collection of data freely available in a cloud-friendly format,\nwe can render map tiles from this imagery on demand with low latency, generally\nwithin 500ms. This on-demand rendering provides multiple benefits:"),"\n",n.createElement(t.ul,null,"\n",n.createElement(t.li,null,"Lower costs. By not storing a copy of the data, you can avoid storage costs for pregenerated imagery. Source NAIP data is over 30TB in size; just to store that data on S3 would cost several hundred dollars a month."),"\n",n.createElement(t.li,null,"Greater image selection flexibility. By not pregenerating any imagery, you can give users the choice of what year's data to view. As soon as a new year's data exists, your maps can be updated."),"\n"),"\n",n.createElement(t.h2,{id:"mosaicjson",style:{position:"relative"}},n.createElement(t.a,{href:"#mosaicjson","aria-label":"mosaicjson permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"MosaicJSON"),"\n",n.createElement(t.p,null,"As described in my ",n.createElement(t.a,{href:"https://kylebarron.dev/blog/cog-mosaic/overview#mosaicjson"},"COG overview blog post"),":"),"\n",n.createElement(t.blockquote,null,"\n",n.createElement(t.p,null,"It's great that all those terabytes of COG exist for public consumption, but\nyou still need a way to select what portions of imagery to combine. That's\nwhere ",n.createElement(t.a,{href:"https://github.com/developmentseed/mosaicjson-spec"},"MosaicJSON")," comes in. It's a file that determines what\nsource files should be merged to create each web mercator map tile."),"\n"),"\n",n.createElement(t.p,null,"Dynamic tiling works by combining multiple source images into a single output\nimage in the web mercator projection ready to send back to the client. This\nprocess requires quickly finding the source images that are necessary to combine\nfor the desired tile."),"\n",n.createElement(t.p,null,"In the NAIP case, the process of assembling a MosaicJSON is relatively simple as\nthe source imagery is intentionally collected in such a way as to create a\nseamless mosaic per state. Images are produced in a regular grid with little\noverlap between source images, all imagery is cloudless, there exists minimal\ntemporal variation (at least within a state), and the dataset is relatively\nstatic (updated yearly)."),"\n",n.createElement(t.p,null,"These factors make it considerably easier to work with mosaics for NAIP imagery\nthan for satellite imagery, which has more overlap between scenes, large\nportions of missing or cloudy data, and high temporal variation."),"\n",n.createElement(t.p,null,"The main thing to keep in mind when creating an NAIP mosaic is to avoid\nincluding multiple years of imagery in a single mosaic, which can slow down\ndynamic tiling. Most of ",n.createElement(t.code,null,"naip-cogeo-mosaic")," is dedicated to working with the\nNAIP metadata to create a seamless, efficient mosaic. Consult ",n.createElement(t.a,{href:"https://github.com/kylebarron/naip-cogeo-mosaic"},"its\ndocumentation")," for more information."),"\n",n.createElement(t.h2,{id:"image-overviews",style:{position:"relative"}},n.createElement(t.a,{href:"#image-overviews","aria-label":"image overviews permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Image Overviews"),"\n",n.createElement(t.p,null,"Cloud-Optimized GeoTIFF files include a number of internal ",n.createElement(t.em,null,"overviews"),":\nlower-resolution, downsampled versions of the image, which are precomputed and\nstored with the image. Each overview level halves the height and width pixels,\nso each additional level reduces the resolution by a factor of 2. These\noverviews enable fast reads at a range of resolutions by minimizing the\namount of bytes that need to be read."),"\n",n.createElement(t.p,null,"NAIP imagery in the ",n.createElement(t.code,null,"naip-visualization")," S3 bucket have full-resolution data\nplus 5 levels of overviews. This means that NAIP data can be read most\nefficiently at ",n.createElement(t.em,null,"six")," zoom levels, in this case zooms 12-17. At zooms higher than\n17, the images look pixelated. At zooms lower than 12, many images need to be\ncombined and downsampled on the fly. To create an image for a single zoom 6\nmercator tile, you'd need to read ",n.createElement(t.em,null,"4,096")," times more data at level 12, then\ndownsample."),"\n",n.createElement(t.p,null,"Unsurprisingly, needing to fetch so many source images reduces performance when\nrendering at lower zooms. A solution to this problem is to create ",n.createElement(t.em,null,"pregenerated\noverviews")," for lower zooms: reading all necessary source images once then\ndownsampling ahead of time. Then when rendering lower zoom images, read from the\nalready-downsampled data."),"\n",n.createElement(t.p,null,"In this case, to serve imagery for zooms 6-11 on the fly, I generate overview\nimages that are themselves Cloud-Optimized GeoTIFFs, each of which contains 5\ninternal overview levels. Pregenerating overviews does lose some flexibility of\nCOGs, as you need to choose how to combine imagery (your MosaicJSON) ahead of\ntime rather than on demand."),"\n",n.createElement(t.p,null,"The ",n.createElement(t.a,{href:"https://github.com/kylebarron/naip-cogeo-mosaic"},n.createElement(t.code,null,"naip-cogeo-mosaic")," documentation")," has more information\non how to use ",n.createElement(t.a,{href:"https://github.com/developmentseed/cogeo-mosaic"},n.createElement(t.code,null,"cogeo-mosaic"))," to create these overviews."),"\n",n.createElement(t.h2,{id:"dynamic-tiling-performance",style:{position:"relative"}},n.createElement(t.a,{href:"#dynamic-tiling-performance","aria-label":"dynamic tiling performance permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Dynamic Tiling Performance"),"\n",n.createElement(t.p,null,"I've spent a lot of time working on performance for dynamic tiling, with the\ngoal of reducing latency to the point that it's viable for a wide range of\napplications."),"\n",n.createElement(t.p,null,"With my current serverless solution hosted on AWS Lambda, I'm able to get around\n500ms latency (longer for cold starts). In the following sections I'll outline\nthe things you should keep in mind to keep performance as high as possible."),"\n",n.createElement(t.h3,{id:"minimize-number-of-source-assets",style:{position:"relative"}},n.createElement(t.a,{href:"#minimize-number-of-source-assets","aria-label":"minimize number of source assets permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Minimize number of source assets"),"\n",n.createElement(t.p,null,"Since GDAL, the program underlying the dynamic tiling process, is synchronous,\nthe largest amount of time is spent waiting on network requests to S3 for each\nportion of the image. Thus, one of the best ways to minimize total time is to\nminimize the number of images the tiler has to fetch to combine into a single\nweb mercator tile."),"\n",n.createElement(t.p,null,"As ",n.createElement(t.a,{href:"#mosaicjson"},"described above"),", this step is done ahead of time, while\ncreating the MosaicJSON. The process of minimizing superfluous source assets is\ntaken care of within ",n.createElement(t.code,null,"naip-cogeo-mosaic")," when you make a mosaic."),"\n",n.createElement(t.h3,{id:"256x256-pixel-images",style:{position:"relative"}},n.createElement(t.a,{href:"#256x256-pixel-images","aria-label":"256x256 pixel images permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"256x256 pixel images"),"\n",n.createElement(t.p,null,"Images used in web maps usually come in square images of either 256x256 pixels\nor 512x512 pixels (@2x resolution). Using @2x resolution tiles requires fewer\nrequests to cover the screen, since each image covers a larger area at the same\nresolution, but each request takes longer. With @1x scale tiles, each tile is\n1/4th the size, so you'll need (roughly) four times the requests."),"\n",n.createElement(t.p,null,"With this project, my goal is to push per-tile latency as low as possible.\nUnsurprisingly, it takes significantly longer—my ballpark estimates are around 2\nto 3 times longer—to generate a @2x scale image than a @1x scale image. Thus,\nserving @1x scale images is preferable when you prioritize speed, but server\ncosts will be slightly higher since you need so many more requests."),"\n",n.createElement(t.h3,{id:"locate-server-in-us-west-2",style:{position:"relative"}},n.createElement(t.a,{href:"#locate-server-in-us-west-2","aria-label":"locate server in us west 2 permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Locate server in ",n.createElement(t.code,null,"us-west-2")),"\n",n.createElement(t.p,null,"The tiler works by"),"\n",n.createElement(t.ol,null,"\n",n.createElement(t.li,null,"Using the MosaicJSON to find URLs of source images that overlap the mercator tile of interest"),"\n",n.createElement(t.li,null,"Reading the relevant portion of each source image"),"\n",n.createElement(t.li,null,"Combining pixels into one output image ready to send back to the client"),"\n"),"\n",n.createElement(t.p,null,"While these three steps work with any file format, Cloud-Optimized GeoTIFFs\nallow for huge speedups on the second part. The COG format is efficient because\nit allows for intelligent streaming of portions of an image, but because a COG\nis internally tiled, the tiling server will likely need several (small) GET\nrequests for each source image. Thus, locating the compute in the same region as\nthe data is absolutely essential for low total latency, as the latency for each\nS3 GET request is larger across regions, and this time gets multiplied by the\nnumber of requests per image, and the number of images needed to combine for one\nmercator tile."),"\n",n.createElement(t.p,null,"Additionally, since NAIP imagery is stored in a Requester Pays S3 bucket,\nlocating the server in the same region will be significantly cheaper as you\nwon't need to pay egress charges on intermediate data transfer."),"\n",n.createElement(t.h3,{id:"use-gdal-24-not-31",style:{position:"relative"}},n.createElement(t.a,{href:"#use-gdal-24-not-31","aria-label":"use gdal 24 not 31 permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Use GDAL 2.4, not 3.1"),"\n",n.createElement(t.p,null,"As of summer 2020, GDAL 2.4 has been tested to be ",n.createElement(t.a,{href:"https://github.com/lambgeo/docker-lambda/issues/2"},n.createElement(t.em,null,"significantly\nfaster"))," (",n.createElement(t.a,{href:"https://github.com/developmentseed/cogeo-mosaic-tiler/issues/4#issuecomment-604120617"},">10x"),") than GDAL 3.1, at least for this specific\nuse case."),"\n",n.createElement(t.h3,{id:"use-dynamodb-as-the-mosaicjson-backend",style:{position:"relative"}},n.createElement(t.a,{href:"#use-dynamodb-as-the-mosaicjson-backend","aria-label":"use dynamodb as the mosaicjson backend permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Use DynamoDB as the MosaicJSON backend"),"\n",n.createElement(t.p,null,"The MosaicJSON defines a mapping from mercator tiles to image urls. Since it\nmust define this mapping for ",n.createElement(t.em,null,"every mercator tile")," (at the minimum zoom, which\nfor NAIP is zoom 12), the MosaicJSON file can get quite large. When saved as a\nJSON file, my United States-wide mosaics are 64MB. Since this mosaic is needed\nfor every dynamic tiling request, storing this data in a JSON file on S3\nrequires the lambda function download and parse it on every request. This adds\nroughly 2.5s per request for such a large mosaic."),"\n",n.createElement(t.p,null,"Luckily, there's an alternative to storing as JSON.\n",n.createElement(t.a,{href:"https://github.com/developmentseed/cogeo-mosaic"},n.createElement(t.code,null,"cogeo-mosaic"))," supports multiple ",n.createElement(t.em,null,"backends"),", one of which is\n",n.createElement(t.a,{href:"https://aws.amazon.com/dynamodb/"},"DynamoDB"),", a serverless, low-latency key-value store. This is ideal\nfor storing mosaics because only one or sometimes two DynamoDB read requests are\nnecessary per dynamic tiling request. This lowers the time spent on the\nMosaicJSON from 2.5s to around 20ms."),"\n",n.createElement(t.h3,{id:"client-side-image-manipulation",style:{position:"relative"}},n.createElement(t.a,{href:"#client-side-image-manipulation","aria-label":"client side image manipulation permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Client-side image manipulation"),"\n",n.createElement(t.p,null,"Often the NAIP imagery is visually a bit bland and benefits from increased\nsaturation. While it's possible to do this server side, it increases image load\ntimes by 100-200ms. For WebGL-enabled map clients like Mapbox GL JS or\n",n.createElement(t.a,{href:"https://deck.gl"},"deck.gl"),", client-side image saturation is easy and\ninstantaneous, so this is better to do client side."),"\n",n.createElement(t.h3,{id:"caching",style:{position:"relative"}},n.createElement(t.a,{href:"#caching","aria-label":"caching permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Caching"),"\n",n.createElement(t.p,null,"I'm a big fan of Cloudflare's free tier as a simple solution to both speed up my\nsite and keep costs low by reducing the number of requests that reach my server.\nSome sort of caching is ideal."),"\n",n.createElement(t.h2,{id:"pricing",style:{position:"relative"}},n.createElement(t.a,{href:"#pricing","aria-label":"pricing permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Pricing"),"\n",n.createElement(t.p,null,"A rough estimate of the cost with my serverless approach is ",n.createElement(t.strong,null,"$25 per million\nrequests"),". Note that this is only for requests ",n.createElement(t.em,null,"that reach Lambda"),"; using\nCloudflare with a long Cache-Control setting should make it effectively even\ncheaper."),"\n",n.createElement(t.ul,null,"\n",n.createElement(t.li,null,"Lambda compute time: $12.5/million requests. On average, each request takes around 500 ms, when Lambda is set to 1536 MB of memory. Note that this is for @1x tiles; @2x tiles take 2-3x longer for compute (but you need fewer requests). If you have significant, stable usage, you could save by not going serverless."),"\n",n.createElement(t.li,null,"Lambda requests: $0.20/million."),"\n",n.createElement(t.li,null,"DynamoDB requests: $0.25/million. Each dynamic tiling request needs a read request to DynamoDB to find the relevant image urls."),"\n",n.createElement(t.li,null,"API Gateway requests: $1.00/million. I use the cheaper, newer HTTP API service instead of the older REST API service, which is $3.50/million."),"\n",n.createElement(t.li,null,"S3 GET requests: $8.00/million. Since NAIP imagery is stored in a requester pays bucket, the user pays for the GET requests. On average there are 4 to 6 source images, and each COG requires between 1 and 5 GET requests, depending on the zoom level and technical factors."),"\n",n.createElement(t.li,null,"Network egress: $2.00/million. Assuming image tiles are served as JPEGs, each image is roughly 25kb. Multiply by 4 if using @2x tiles. PNGs are significantly larger."),"\n"),"\n",n.createElement(t.p,null,"This is a pretty good value. Once you surpass Mapbox's (generous) free tier,\ntheir satellite imagery costs $250/million requests. (Though that's not a direct\napples-to-apples comparison, since you can request @2x tiles from Mapbox for\napparently the same price.) But apart from being cheap, a great benefit of the\ndynamic tiling approach is that you can choose ",n.createElement(t.em,null,"any")," combination of imagery you\nwish. It's just as easy to serve tiles from 2011 as it is from 2018."),"\n",n.createElement(t.h2,{id:"drawbacks",style:{position:"relative"}},n.createElement(t.a,{href:"#drawbacks","aria-label":"drawbacks permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Drawbacks"),"\n",n.createElement(t.p,null,"That said, there are a few drawbacks to using NAIP imagery and reasons why tiled\nimagery from a commercial company such as Mapbox can often be better."),"\n",n.createElement(t.ul,null,"\n",n.createElement(t.li,null,n.createElement(t.strong,null,"No global coverage"),": NAIP data only exists for the continental U.S. The highest-resolution public, global satellite imagery I know of is Sentinel 2 data, which has a 10-meter resolution."),"\n",n.createElement(t.li,null,n.createElement(t.strong,null,"Image quality"),": while NAIP generally has good image quality, across large areas seams are quite noticeable. NAIP is ideal when zoomed in; it can look downsampled and patchy at low zooms."),"\n",n.createElement(t.li,null,n.createElement(t.strong,null,"Missing areas within U.S."),": some areas within the continental U.S., especially military bases, are not photographed by the NAIP program."),"\n"),"\n",n.createElement(t.p,null,'Since this project was designed for exploration and to be "good enough" for\nhobby mapping projects, these drawbacks are fine for my needs.'),"\n",n.createElement(t.h2,{id:"conclusion",style:{position:"relative"}},n.createElement(t.a,{href:"#conclusion","aria-label":"conclusion permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Conclusion"),"\n",n.createElement(t.p,null,"If you appreciate this data, ",n.createElement(t.strong,null,"talk to your elected officials"),". ",n.createElement(t.a,{href:"https://en.wikipedia.org/wiki/National_Agriculture_Imagery_Program"},"According to\nWikipedia"),", USDA is considering removing NAIP imagery from the\npublic domain in the near future."),"\n",n.createElement(t.h2,{id:"references",style:{position:"relative"}},n.createElement(t.a,{href:"#references","aria-label":"references permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"References"),"\n",n.createElement(t.ul,null,"\n",n.createElement(t.li,null,n.createElement(t.a,{href:"https://github.com/kylebarron/naip-cogeo-mosaic"},n.createElement(t.code,null,"naip-cogeo-mosaic")),": the open source project underlying this blog post. Refer to its documentation for how to deploy."),"\n",n.createElement(t.li,null,n.createElement(t.a,{href:"https://developmentseed.org/titiler/"},"Titiler"),": a next-generation dynamic tiling server that supports both serverless and server deployment. I'd recommend this over ",n.createElement(t.code,null,"cogeo-mosaic-tiler")," for all new deployments."),"\n"),"\n",n.createElement(t.h2,{id:"acknowledgements",style:{position:"relative"}},n.createElement(t.a,{href:"#acknowledgements","aria-label":"acknowledgements permalink",className:"anchor before"},n.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Acknowledgements"),"\n",n.createElement(t.p,null,"Thanks to ",n.createElement(t.a,{href:"https://twitter.com/_VincentS_"},"Vincent Sarago"),", ",n.createElement(t.a,{href:"https://twitter.com/geospatialjeff"},"Jeff Albrecht"),", and many others for\ntheir invaluable feedback and work pushing the Cloud-Optimized GeoTIFF ecosystem\nforward."))}var o=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,i.ah)(),e.components);return t?n.createElement(t,e,n.createElement(r,e)):r(e)},l=a(4765);function s(e){return n.createElement(l.Z,e,n.createElement(o,e))}l.Z}}]);
//# sourceMappingURL=component---node-modules-lekoarts-gatsby-theme-minimal-blog-core-src-templates-post-query-tsx-content-file-path-content-posts-cog-mosaic-naip-index-mdx-80b50e92a5f9f44c2912.js.map